<html>
    <head>
        <title>Helios Node</title>
        <link rel="icon" type="image/png" href="favicon.png">
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
        <link rel="stylesheet" href="style.css">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>
        <div class="sidebar"></div>

        <!-- Notification Container -->
        <div class="notification-container" id="notification-container"></div>

        <div class="main-content" style="display: none">
            <div class="status-page">
                <section class="status-panels">
                    <!-- Hero Header -->
                    <article class="status-card status-overview-card">
                        <div class="overview-header">
                            <div class="status-hero-text">
                                <span class="status-hero-eyebrow">Validator Management</span>
                                <h1>Validator Dashboard</h1>
                                <p>Manage your validator, monitor delegations, claim rewards, and track commission earnings.</p>
                            </div>
                        </div>
                    </article>

                    <!-- Create Validator Form (shown when no validator exists) -->
                    <div id="validator-form-container" style="display: none;"></div>

                    <!-- Validator Information Card -->
                    <article class="status-card" id="validator-info-container" style="display: none;">
                        <div class="card-header">
                            <div class="card-title">
                                <span class="material-icons">how_to_reg</span>
                                <div>
                                    <h2>Validator Information</h2>
                                    <p>Your validator status and configuration details.</p>
                                </div>
                            </div>
                        </div>
                        <div class="settings-body">
                            <div id="validator-info">
                                <!-- Les informations du validator seront affichées ici -->
                            </div>
                        </div>
                    </article>

                    <!-- Commission Card -->
                    <article class="status-card" id="validator-commission-info-container" style="display: none;">
                        <div class="card-header">
                            <div class="card-title">
                                <span class="material-icons">account_balance_wallet</span>
                                <div>
                                    <h2>My Commissions</h2>
                                    <p>Earnings from validator commissions available to claim.</p>
                                </div>
                            </div>
                        </div>
                        <div class="settings-body">
                            <div id="commissions-info">
                                <!-- Les informations de commission seront affichées ici -->
                            </div>
                        </div>
                    </article>

                    <!-- Delegated Assets Card -->
                    <article class="status-card" id="validator-assets-info-container" style="display: none;">
                        <div class="card-header">
                            <div class="card-title">
                                <span class="material-icons">account_balance</span>
                                <div>
                                    <h2>My Delegated Assets</h2>
                                    <p>Overview of all assets delegated to your validator.</p>
                                </div>
                            </div>
                        </div>
                        <div class="settings-body">
                            <div id="assets-info">
                                <!-- Les informations de délégation seront affichées ici -->
                            </div>
                        </div>
                    </article>

                    <!-- Delegations Card -->
                    <article class="status-card" id="validator-delegation-info-container" style="display: none;">
                        <div class="card-header">
                            <div class="card-title">
                                <span class="material-icons">trending_up</span>
                                <div>
                                    <h2>My Delegations</h2>
                                    <p>Active delegations and available rewards to claim.</p>
                                </div>
                            </div>
                        </div>
                        <div class="settings-body">
                            <div id="delegations-info">
                                <!-- Les informations de délégation seront affichées ici -->
                            </div>
                        </div>
                    </article>
                </section>
            </div>
        </div>
        <script>
            let password = window.localStorage.getItem("access-code");

            const showNotification = (type, title, message, duration = 5000) => {
                const container = document.getElementById('notification-container');
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                
                const iconMap = {
                    success: 'check_circle',
                    error: 'error',
                    warning: 'warning',
                    info: 'info'
                };
                
                notification.innerHTML = `
                    <div class="notification-icon">
                        <span class="material-icons">${iconMap[type] || 'info'}</span>
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">${title}</div>
                        <div class="notification-message">${message}</div>
                    </div>
                    <button class="notification-close" onclick="this.parentElement.remove()">
                        <span class="material-icons">close</span>
                    </button>
                    <div class="notification-progress" style="width: 100%"></div>
                `;
                
                container.appendChild(notification);
                
                setTimeout(() => {
                    notification.classList.add('show');
                }, 10);
                
                if (duration > 0) {
                    setTimeout(() => {
                        notification.classList.add('hide');
                        setTimeout(() => {
                            if (notification.parentElement) {
                                notification.remove();
                            }
                        }, 400);
                    }, duration);
                    
                    const progress = notification.querySelector('.notification-progress');
                    progress.style.transition = `width ${duration}ms linear`;
                    setTimeout(() => {
                        progress.style.width = '0%';
                    }, 10);
                }
            };

            const formatLargeNumber = (value) => {
                if (!value || value === 'N/A') return 'N/A';
                
                const num = parseFloat(value);
                if (isNaN(num)) return value;
                
                if (num >= 1e18) {
                    return (num / 1e18).toFixed(2) + 'e18';
                } else if (num >= 1e15) {
                    return (num / 1e15).toFixed(2) + 'e15';
                } else if (num >= 1e12) {
                    return (num / 1e12).toFixed(2) + 'e12';
                } else if (num >= 1e9) {
                    return (num / 1e9).toFixed(2) + 'e9';
                } else if (num >= 1e6) {
                    return (num / 1e6).toFixed(2) + 'e6';
                } else if (num >= 1e3) {
                    return (num / 1e3).toFixed(2) + 'e3';
                } else {
                    return num.toFixed(2);
                }
            };

            const main = async () => {

                if (password == undefined) {
                    window.location = '/';
                    return ;
                }
                if (!(await isSetup())) {
                    window.location = '/setup';
                    return ;
                }
                displaySideBar();
                document.querySelectorAll('.main-content')[0].style.display = '';

                const validatorAndHisAssetsAndCommission = await apiGetValidatorAndHisAssetsAndCommission();

                if (validatorAndHisAssetsAndCommission == undefined) {
                    console.log('displayCreateValidator')
                    document.getElementById('validator-form-container').style.display = '';
                    document.getElementById('validator-info-container').style.display = 'none';
                    document.getElementById('validator-commission-info-container').style.display = 'none';
                    document.getElementById('validator-delegation-info-container').style.display = 'none';
                    document.getElementById('validator-assets-info-container').style.display = 'none';
                    displayCreateValidator();
                } else {
                    document.getElementById('validator-form-container').style.display = 'none';
                    document.getElementById('validator-info-container').style.display = '';
                    document.getElementById('validator-commission-info-container').style.display = '';
                    document.getElementById('validator-delegation-info-container').style.display = '';
                    document.getElementById('validator-assets-info-container').style.display = '';
                    displayValidatorInfo(validatorAndHisAssetsAndCommission.validator);
                    // displayDelegationInfo(validatorAndHisDelegation.delegation);
                    displayCommissionInfo(validatorAndHisAssetsAndCommission.commission, validatorAndHisAssetsAndCommission.validator);
                    await displayAssetsInfo(validatorAndHisAssetsAndCommission.assets);


                    const delegations = await apiGetDelegations(validatorAndHisAssetsAndCommission.validator.validatorAddress);

                    if (delegations.length > 0) {
                        await displayDelegationInfo(delegations);
                    }
                }
            }

            const unbond = async () => {

            }

            const claim = async () => {
                const walletPassword = await new Promise((resolve) => {
                    try {
                        pw_prompt({
                            lm: "Please enter your wallet password:", 
                            callback: function(password) {
                                resolve(password);
                            }
                        });
                    } catch (e) {
                        resolve('');
                    }
                })
                
                if (!walletPassword) {
                    showNotification('error', 'Password Required', 'Password is required to claim rewards');
                    return;
                }
                
                showNotification('info', 'Processing', 'Claiming rewards...');
                const result = await apiValidatorClaim(walletPassword);
                
                if (result && !result.error) {
                    showNotification('success', 'Success!', 'Rewards claimed successfully');
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    showNotification('error', 'Error', result?.error || 'Failed to claim rewards');
                }
            }

            const claimCommission = async () => {
                const walletPassword = await new Promise((resolve) => {
                    try {
                        pw_prompt({
                            lm: "Please enter your wallet password:", 
                            callback: function(password) {
                                resolve(password);
                            }
                        });
                    } catch (e) {
                        resolve('');
                    }
                })
                
                if (!walletPassword) {
                    showNotification('error', 'Password Required', 'Password is required to claim commission');
                    return;
                }
                
                showNotification('info', 'Processing', 'Claiming commission...');
                const result = await apiValidatorClaimCommission(walletPassword);
                
                if (result && !result.error) {
                    showNotification('success', 'Success!', 'Commission claimed successfully');
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    showNotification('error', 'Error', result?.error || 'Failed to claim commission');
                }
            }

            const createValidator = async (displayedValidator) => {
                const walletPassword = await new Promise((resolve) => {
                    try {
                        pw_prompt({
                            lm: "Please enter your wallet password:", 
                            callback: function(password) {
                                resolve(password);
                            }
                        });
                    } catch (e) {
                        resolve('');
                    }
                })
                
                if (!walletPassword) {
                    showNotification('error', 'Password Required', 'Password is required to create validator');
                    return;
                }
                
                showNotification('info', 'Processing', 'Creating validator...');
                const result = await apiValidatorCreate(walletPassword);
                
                if (result && !result.error) {
                    showNotification('success', 'Success!', 'Validator created successfully');
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    showNotification('error', 'Error', result?.error || 'Failed to create validator');
                }
            }

            const unjailNode = async (validatorAddress) => {
                const walletPassword = await new Promise((resolve) => {
                    try {
                        pw_prompt({
                            lm: "Please enter your wallet password:", 
                            callback: function(password) {
                                resolve(password);
                            }
                        });
                    } catch (e) {
                        resolve('');
                    }
                })
                
                if (!walletPassword) {
                    showNotification('error', 'Password Required', 'Password is required to unjail node');
                    return;
                }
                
                showNotification('info', 'Processing', 'Unjailing node...');
                const result = await apiValidatorUnjail(walletPassword);
                
                if (result === undefined) {
                    showNotification('error', 'Error', 'Failed to unjail node');
                    return;
                }
                
                showNotification('success', 'Success!', 'Node unjailed successfully');
                setTimeout(() => window.location.reload(), 2000);
            }

            const displayCreateValidator = () => {
                const formHtml = `
                    <article class="status-card">
                        <div class="card-header">
                            <div class="card-title">
                                <span class="material-icons">how_to_reg</span>
                                <div>
                                    <h2>Create Validator</h2>
                                    <p>Configure your validator settings and commission rates.</p>
                                </div>
                            </div>
                        </div>
                        <div class="settings-body">
                            <form id="validator-form">
                                <h3 style="margin-bottom: 1rem; color: var(--text-primary);">
                                    <span class="material-icons" style="vertical-align: middle; margin-right: 0.5rem;">percent</span>
                                    Commission Rates
                                </h3>
                                
                                <div class="settings-group">
                                    <label for="commission-rate">Rate * (0-1)</label>
                                    <input type="number" 
                                           id="commission-rate" 
                                           name="commission-rate"
                                           class="form-input"
                                           placeholder="Ex: 0.05 for 5%"
                                           min="0"
                                           max="1"
                                           step="0.01"
                                           required>
                                    <p class="help-text">Initial commission rate (ex: 0.05 for 5%)</p>
                                </div>

                                <div class="settings-group">
                                    <label for="commission-max-rate">Max Rate * (0-1)</label>
                                    <input type="number" 
                                           id="commission-max-rate" 
                                           name="commission-max-rate"
                                           class="form-input"
                                           placeholder="Ex: 0.20 for 20%"
                                           min="0"
                                           max="1"
                                           step="0.01"
                                           required>
                                    <p class="help-text">Maximum rate possible</p>
                                </div>

                                <div class="settings-group">
                                    <label for="commission-max-change-rate">Max Change Rate * (0-1)</label>
                                    <input type="number" 
                                           id="commission-max-change-rate" 
                                           name="commission-max-change-rate"
                                           class="form-input"
                                           placeholder="Ex: 0.01 for 1%"
                                           min="0"
                                           max="1"
                                           step="0.01"
                                           required>
                                    <p class="help-text">Maximum change per update</p>
                                </div>

                                <h3 style="margin: 2rem 0 1rem; color: var(--text-primary);">
                                    <span class="material-icons" style="vertical-align: middle; margin-right: 0.5rem;">settings</span>
                                    Validator Settings
                                </h3>

                                <div class="settings-group">
                                    <label for="min-self-delegation">Min Self Delegation * (1 = 1 share)</label>
                                    <input type="number" 
                                           id="min-self-delegation" 
                                           name="min-self-delegation"
                                           class="form-input"
                                           placeholder="Minimum self delegation amount"
                                           min="1"
                                           step="1"
                                           required>
                                    <p class="help-text">Minimum self delegation amount</p>
                                </div>

                                <button type="submit" class="button primary">
                                    <span class="material-icons">check</span>
                                    Create Validator
                                </button>
                            </form>
                        </div>
                    </article>
                `;

                const container = document.getElementById('validator-form-container');
                container.innerHTML = formHtml;
                container.style.display = '';

                document.getElementById('validator-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    try {
                        const formData = {
                            commission: {
                                rate: document.getElementById('commission-rate').value,
                                maxRate: document.getElementById('commission-max-rate').value,
                                maxChangeRate: document.getElementById('commission-max-change-rate').value
                            },
                            minSelfDelegation: document.getElementById('min-self-delegation').value,
                            value: "1"
                        };

                        // Validation des données
                        const rate = parseFloat(formData.commission.rate);
                        const maxRate = parseFloat(formData.commission.maxRate);
                        const maxChangeRate = parseFloat(formData.commission.maxChangeRate);

                        if (isNaN(rate) || rate < 0 || rate > 1) {
                            showNotification('error', 'Validation Error', 'Commission rate must be between 0 and 1');
                            return;
                        }
                        if (isNaN(maxRate) || maxRate < 0 || maxRate > 1) {
                            showNotification('error', 'Validation Error', 'Max commission rate must be between 0 and 1');
                            return;
                        }
                        if (isNaN(maxChangeRate) || maxChangeRate < 0 || maxChangeRate > 1) {
                            showNotification('error', 'Validation Error', 'Max change rate must be between 0 and 1');
                            return;
                        }
                        if (rate > maxRate) {
                            showNotification('error', 'Validation Error', 'Commission rate cannot be greater than max rate');
                            return;
                        }

                        const walletPassword = await new Promise((resolve) => {
                            try {
                                pw_prompt({
                                    lm: "Please enter your wallet password:", 
                                    callback: function(password) {
                                        resolve(password);
                                    }
                                });
                            } catch (e) {
                                resolve('');
                            }
                        });

                        if (!walletPassword) {
                            showNotification('error', 'Password Required', 'Password is required to create validator');
                            return;
                        }

                        showNotification('info', 'Processing', 'Creating validator...');
                        const result = await apiValidatorCreate(walletPassword, formData);
                        
                        if (result === undefined) {
                            showNotification('error', 'Error', 'Failed to create validator');
                            return;
                        }
                        
                        showNotification('success', 'Success!', 'Validator created successfully');
                        setTimeout(() => window.location.reload(), 2000);
                    } catch (error) {
                        console.error("Error:", error);
                        showNotification('error', 'Error', 'An error occurred while creating the validator: ' + error.message);
                    }
                });
            }

            const displayValidatorInfo = (validator) => {
                const validatorInfoDiv = document.getElementById('validator-info');
                
                const statusClass = validator.jailed ? 'status-pill is-error' : 'status-pill is-success';
                const statusText = validator.jailed ? 'Jailed' : 'Active';
                
                validatorInfoDiv.innerHTML = `
                    <div class="validator-stats">
                        <div class="stat-item">
                            <div class="stat-label">
                                <span class="material-icons">trending_up</span>
                                APR
                            </div>
                            <div class="stat-value">${validator.apr || 'N/A'}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">
                                <span class="material-icons">label</span>
                                Moniker
                            </div>
                            <div class="stat-value">${validator.moniker || 'N/A'}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">
                                <span class="material-icons">info</span>
                                Status
                            </div>
                            <div class="${statusClass}">${statusText}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">
                                <span class="material-icons">account_balance</span>
                                Min Self Delegation
                            </div>
                            <div class="stat-value">${validator.minSelfDelegation || 'N/A'}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">
                                <span class="material-icons">donut_large</span>
                                Shares
                            </div>
                            <div class="stat-value">${Web3.utils.fromWei(validator.shares.split('.')[0], 'ether')}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">
                                <span class="material-icons">percent</span>
                                Rate
                            </div>
                            <div class="stat-value">${validator.commission?.commission_rates?.rate || 'N/A'}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">
                                <span class="material-icons">analytics</span>
                                Max Rate
                            </div>
                            <div class="stat-value">${validator.commission?.commission_rates?.max_rate || 'N/A'}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">
                                <span class="material-icons">speed</span>
                                Max Change Rate
                            </div>
                            <div class="stat-value">${validator.commission?.commission_rates?.max_change_rate || 'N/A'}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">
                                <span class="material-icons">schedule</span>
                                Update Time
                            </div>
                            <div class="stat-value" style="font-size: 0.875rem;">${validator.commission?.update_time || 'N/A'}</div>
                        </div>
                        <div class="stat-item" style="grid-column: 1 / -1;">
                            <div class="stat-label">
                                <span class="material-icons">fingerprint</span>
                                Validator Address
                            </div>
                            <div class="stat-value" style="font-size: 0.875rem; word-break: break-all;">${validator.validatorAddress || 'N/A'}</div>
                        </div>
                    </div>
                `;

                if (validator.jailed) {
                    const actionButtons = document.createElement('div');
                    actionButtons.className = 'action-buttons';
                    actionButtons.style.marginTop = '1.5rem';
                    actionButtons.innerHTML = `
                        <button class="button danger" onclick="unjailNode('${validator.validatorAddress}')">
                            <span class="material-icons">restore</span>
                            Unjail Node
                        </button>
                    `;
                    validatorInfoDiv.appendChild(actionButtons);
                }
            }

            const displayDelegationInfo = async (delegations) => {
                if (delegations == undefined || delegations.length == 0) {
                    return ;
                }

                const delegationsInfoDiv = document.getElementById('delegations-info');
                let html = ``;

                const promises = delegations.map(async (delegation) => {
                    const rewardsAmount = Web3.utils.fromWei(delegation.rewards.amount, 'ether');
                    const rewardsDenom = delegation.rewards.denom;
                    const validatorAddress = delegation.validatorAddress;

                    console.log(delegation.validatorAddress);

                    let htmlOfDelegation = ``;
                    // create one div for each validator address
                    htmlOfDelegation += `
                        <div class="rewards-section">
                            <div class="rewards-title">
                                <i class="material-icons">account_balance</i>
                                ${delegation.validatorAddress}
                            </div>
                    `;

                    htmlOfDelegation += `
                        <div class="rewards-section">
                            <div class="rewards-title">
                                <i class="material-icons">redeem</i>
                                Available Rewards
                            </div>
                            <div class="rewards-amount">${rewardsAmount} ${rewardsDenom}</div>
                            <div class="action-buttons">
                                <button id="claim-rewards-btn" class="button primary">
                                    <i class="material-icons">redeem</i>
                                    <span>Claim Rewards</span>
                                </button>
                            </div>
                        </div>
                    `;

                                         if (delegation.assets && delegation.assets.length > 0) {
                         htmlOfDelegation += `
                             <div style="margin-top: 1.5rem;">
                                 <div class="commission-title">
                                     <i class="material-icons">account_balance</i>
                                     Delegated Assets
                                 </div>
                                 <div class="delegations-table-container">
                                     <table class="delegations-table">
                                         <thead>
                                             <tr>
                                                 <th>Amount</th>
                                                 <th>Symbol</th>
                                                 <th>Contract Address</th>
                                                 <th>Origin Blockchain ID</th>
                                                 <th>Actions</th>
                                             </tr>
                                         </thead>
                                         <tbody>
                         `;
                         
                         for (const asset of delegation.assets) {
                             const amountSplitted = asset.amount.split('.');
                             const amount = Web3.utils.fromWei(amountSplitted[0], 'ether');
                             const tokenDetails = await getTokenDetails(asset.denom);

                             const symbol = tokenDetails?.metadata?.symbol || asset.denom;
                             let originBlockchainId = '42000';

                             if (tokenDetails?.metadata?.chainsMetadatas != undefined) {
                                 const chainsMetadatas = tokenDetails?.metadata?.chainsMetadatas;
                                 originBlockchainId = chainsMetadatas.find(chain => chain.isOriginated)?.chainId || 'N/A';
                             }

                             let contractAddress = asset.denom;
                             if (tokenDetails?.metadata?.contract_address != undefined) {
                                contractAddress = tokenDetails?.metadata?.contract_address;
                             }

                             htmlOfDelegation += `
                                 <tr>
                                     <td class="amount-cell">${amount}</td>
                                     <td class="symbol-cell">${symbol}</td>
                                     <td class="contract-cell">${contractAddress}</td>
                                     <td class="origin-cell">${originBlockchainId}</td>
                                     <td class="actions-cell">
                                         <!--- <button class="button tertiary small" onclick="undelegate('${delegation.validatorAddress}', '${asset.denom}')" title="Undelegate">
                                             <span class="material-icons">remove_circle</span>
                                         </button>
                                         <button class="button tertiary small" onclick="delegate('${delegation.validatorAddress}', '${asset.denom}')" title="Delegate">
                                             <span class="material-icons">add_circle</span>
                                         </button> -->
                                     </td>
                                 </tr>
                             `;
                         };
                         
                         htmlOfDelegation += '</tbody></table></div>';
                     }

                    htmlOfDelegation += `
                        </div>
                    `;
                    return htmlOfDelegation;
                });

                const rows = await Promise.all(promises);
                html += rows.join('');

                delegationsInfoDiv.innerHTML = html;

                const claimBtn = document.getElementById('claim-rewards-btn');
                if (claimBtn) claimBtn.onclick = async () => { await claim(); };
            }

            const displayAssetsInfo = async (assets) => {
                if (assets == undefined || assets.length == 0) {
                    return ;
                }
                const assetsInfoDiv = document.getElementById('assets-info');

                let html = ``;

                if (assets.length > 0) {
                    html += `
                        <div style="margin-top: 1.5rem;">
                            <div class="commission-title">
                                <i class="material-icons">account_balance</i>
                                Delegated Assets
                            </div>
                            <div class="assets-table-container">
                                <table class="assets-table">
                                    <thead>
                                        <tr>
                                            <th>Amount</th>
                                            <th style="color: #FFF;">Symbol</th>
                                            <th>Contract Address</th>
                                            <th>Origin Blockchain ID</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    const promises = assets.map(async (asset) => {
                        const amount = Web3.utils.fromWei(asset.baseAmount, 'ether');
                        const contractAddress = asset.contractAddress;
                        const tokenDetails = await getTokenDetails(contractAddress);

                        const symbol = tokenDetails?.metadata?.symbol || 'N/A';
                        let originBlockchainId = '42000';

                        if (tokenDetails?.metadata?.chainsMetadatas != undefined) {
                            const chainsMetadatas = tokenDetails?.metadata?.chainsMetadatas;
                            originBlockchainId = chainsMetadatas.find(chain => chain.isOriginated)?.chainId || 'N/A';
                        }

                        return `
                            <tr>
                                <td class="amount-cell">${amount}</td>
                                <td class="symbol-cell">${symbol}</td>
                                <td class="contract-cell">${contractAddress}</td>
                                <td class="origin-cell">${originBlockchainId}</td>
                            </tr>
                        `;
                    });
                    
                    const rows = await Promise.all(promises);
                    html += rows.join('') + '</tbody></table></div>';
                }

                assetsInfoDiv.innerHTML = html;
                console.log(assets);
            }

            const getTokenDetails = async (contractAddress) => {
                try {
                    if (window.localStorage.getItem(contractAddress) != undefined) {
                        return JSON.parse(window.localStorage.getItem(contractAddress));
                    }
                    if (!contractAddress.startsWith('0x')) {
                        return undefined;
                    }
                    const tokenDetails = await apiGetTokenDetails(contractAddress);

                    if (tokenDetails != undefined && tokenDetails !== false) {
                        window.localStorage.setItem(contractAddress, JSON.stringify(tokenDetails));
                        if (tokenDetails.metadata?.base != undefined) {
                            window.localStorage.setItem(tokenDetails.metadata.base, JSON.stringify(tokenDetails));
                        }
                    }
                    return tokenDetails;
                } catch (e) {
                    console.log(e);
                    return undefined;
                }
            }

            const undelegate = async (validatorAddress, denom) => {
                if (confirm(`Are you sure you want to undelegate from validator ${validatorAddress}?\n\nDenom: ${denom}`)) {
                    try {
                        // TODO: Implement undelegate API call
                        console.log('Undelegating:', { validatorAddress, denom });
                        alert('Undelegate functionality will be implemented soon');
                    } catch (error) {
                        console.error('Error undelegating:', error);
                        alert('Error undelegating: ' + error.message);
                    }
                }
            }

            const delegate = async (validatorAddress, denom) => {
                try {
                    const newValidatorAddress = prompt('Enter the new validator address to redelegate to:');
                    if (newValidatorAddress && newValidatorAddress.trim()) {
                        if (confirm(`Are you sure you want to delegate to ${newValidatorAddress}?\n\nDenom: ${denom}`)) {
                            // TODO: Implement delegate API call
                            console.log('Delegating:', { 
                                fromValidator: validatorAddress, 
                                toValidator: newValidatorAddress, 
                                denom 
                            });
                            alert('Redelegate functionality will be implemented soon');
                        }
                    }
                } catch (error) {
                    console.error('Error redelegating:', error);
                    alert('Error redelegating: ' + error.message);
                }
            }

            const displayCommissionInfo = (commission, validator) => {
                if (commission == undefined || commission.amount == undefined) {
                    return ;
                }
                const commissionInfoDiv = document.getElementById('commissions-info');

                const amount = Web3.utils.fromWei(commission.amount, 'ether');
                
                let html = `
                    <div class="commission-section">
                        <div class="wallet-info-grid">
                            <div class="wallet-info-item">
                                <div class="info-label">
                                    <span class="material-icons">redeem</span>
                                    <span>Available Commission</span>
                                </div>
                                <div class="info-value balance-large">
                                    <span>${amount}</span>
                                    <span class="currency">${commission.denom}</span>
                                </div>
                            </div>
                        </div>
                        <div class="action-buttons" style="margin-top: 1.5rem;">
                            <button id="claim-commission-btn" class="button primary">
                                <span class="material-icons">redeem</span>
                                Claim Commission
                            </button>
                            <button id="delegate-btn" class="button secondary">
                                <span class="material-icons">open_in_new</span>
                                View on Portal
                            </button>
                        </div>
                    </div>
                `;
                
                commissionInfoDiv.innerHTML = html;

                const claimCommissionBtn = document.getElementById('claim-commission-btn');
                if (claimCommissionBtn) claimCommissionBtn.onclick = async () => { await claimCommission(); };
                const delegateBtn = document.getElementById('delegate-btn');
                if (delegateBtn) delegateBtn.onclick = async () => {
                    window.open(`https://portal.helioschain.network/validators/${validator.validatorAddress}`, '_blank');
                };
            }

            window.addEventListener('DOMContentLoaded', async (event) => {
                await main();
            });

        </script>
        <script src="js/theme.js"></script>
        <script src="js/side-bar.js"></script>
        <script src="js/utils.js"></script>
        <script src="js/api.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    </body>
</html>