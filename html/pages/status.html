<html>
    <head>
        <title>Helios Node</title>
        <link rel="icon" type="image/png" href="favicon.png">
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
        <link rel="stylesheet" href="style.css">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            /* Custom Tabs CSS */
            .custom-tabs {
                display: flex;
                border-bottom: 1px solid #e0e0e0;
                margin-bottom: 20px;
            }

            .custom-tab-button {
                background: none;
                border: none;
                padding: 12px 20px;
                cursor: pointer;
                border-bottom: 3px solid transparent;
                color: #FFF;
                font-weight: 500;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .custom-tab-button:hover {
                color: #333;
                background-color: #f5f5f5;
            }

            .custom-tab-button.active {
                color: #2196F3;
                border-bottom-color: #2196F3;
                background-color: #f0f8ff;
            }

            .custom-tab-content {
                position: relative;
            }

            .custom-tab-pane {
                display: none;
                animation: fadeIn 0.3s ease-in;
            }

            .custom-tab-pane.active {
                display: block;
            }

            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
        </style>
    </head>
    <body>
        <div class="sidebar"></div>

        <div class="main-content" style="display: none">
            <div class="status-page">
                <section class="status-panels">
                    <article class="status-card status-overview-card">
                        <div class="overview-header">
                            <div class="status-hero-text">
                                <span class="status-hero-eyebrow">Monitoring Center</span>
                                <h1>Helios Node Status</h1>
                                <p>Monitor node health, review live logs, and manage peers from a single control surface.</p>
                            </div>
                            <div class="status-hero-meta overview-summary">
                                <div class="summary-item">
                                    <span class="summary-label">Status</span>
                                    <div class="status-badge" id="node-status-badge">Inactive</div>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Node Address</span>
                                    <div class="node-address-chip" id="node-address">
                                        <span id="address-text">---</span>
                                        <button class="icon-button" type="button" onclick="copyAddress()" aria-label="Copy node address">
                                            <span class="material-icons">content_copy</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="node-actions overview-body">
                            <div class="node-overview">
                                <div class="node-detail">
                                    <span class="detail-label">Mode</span>
                                    <span class="detail-value" id="node-mode">---</span>
                                </div>
                                <div class="node-detail">
                                    <span class="detail-label">Latest Block</span>
                                    <span class="detail-value" id="node-height">---</span>
                                </div>
                                <div class="node-detail">
                                    <span class="detail-label">Sync Status</span>
                                    <span class="detail-value status-pill" id="node-sync">---</span>
                                </div>
                            </div>
                            <div class="node-controls">
                                <div class="controls-header">
                                    <span class="material-icons">account_tree</span>
                                    <div>
                                        <h3>Node Controls</h3>
                                        <p>Start or stop your node and run advanced commands when you need them.</p>
                                    </div>
                                </div>
                                <div class="node-action-buttons">
                                    <button id="btnStart" class="button primary" onclick="startNode1(this)" disabled>
                                        <span class="material-icons">play_arrow</span>
                                        Start
                                    </button>
                                    <button id="btnStop" class="button secondary" onclick="stopNode1(this)" disabled>
                                        <span class="material-icons">stop</span>
                                        Stop
                                    </button>
                                    <button id="btnMore" class="button tertiary" onclick="showMoreOptions()">
                                        <span class="material-icons">tune</span>
                                        Commands
                                    </button>
                                </div>
                            </div>
                        </div>
                    </article>

                    <article class="status-card logs-card">
                        <div class="card-header">
                            <div class="card-title">
                                <span class="material-icons">terminal</span>
                                <div>
                                    <h2>Node Logs</h2>
                                    <p>Watch live output to detect anomalies before they become incidents.</p>
                                </div>
                            </div>
                            <button class="button tertiary" id="pause-logs">Pause</button>
                        </div>
                        <div class="logs-container" id="node1-logs">
                            <pre></pre>
                        </div>
                    </article>

                    <article class="status-card peers-card">
                        <div class="card-header">
                            <div class="card-title">
                                <span class="material-icons">people</span>
                                <div>
                                    <h2>Peers</h2>
                                    <p>Review network connections and adjust persistent peers as needed.</p>
                                </div>
                            </div>
                            <div class="status-badge" id="peers-badge"></div>
                        </div>

                        <div class="peer-section">
                            <h3 class="peer-section-title">
                                <span class="material-icons">account_circle</span>
                                My Node
                            </h3>
                            <div class="my-node-info" id="my-node-info">
                                <div class="peer-card my-node">
                                    <div class="peer-copy">
                                        <button class="button tertiary small" onclick="copyMyPeerId()" title="Copy Peer ID">
                                            <span class="material-icons">content_copy</span>
                                        </button>
                                    </div>
                                    <div class="peer-info">
                                        <div class="peer-id" id="my-peer-id">Loading...</div>
                                    </div>
                                    <div class="peer-actions">
                                        <button class="button tertiary small" onclick="copyMyPeerId()" title="Copy Peer ID">
                                            <span class="material-icons">content_copy</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="peer-section">
                            <h3 class="peer-section-title">
                                <span class="material-icons">group</span>
                                AddrBook Peers
                                <span class="peer-count" id="addrbook-count">(0)</span>
                            </h3>
                            <div class="peers-grid" id="addrbook-peers">
                                <div class="no-peers">
                                    <span class="material-icons">group_off</span>
                                    <p>No AddrBook peers connected</p>
                                </div>
                            </div>
                        </div>

                        <div class="peer-section">
                            <h3 class="peer-section-title">
                                <span class="material-icons">link</span>
                                Persistent Peers
                                <span class="peer-count" id="persistent-count">(0)</span>
                            </h3>
                            <div class="peers-grid" id="persistent-peers">
                                <div class="no-peers">
                                    <span class="material-icons">link_off</span>
                                    <p>No persistent peers configured</p>
                                </div>
                            </div>
                        </div>

                        <div class="peer-actions-footer">
                            <button id="add-new-peer" class="button primary" onclick="addNewPeer(this)">
                                <span class="material-icons">add</span>
                                Add New Peer
                            </button>
                        </div>
                    </article>
                </section>
            </div>
        </div>

        <!-- Commands Modal -->
        <div id="commands-modal" class="modal fullscreen-modal" style="display: none;">
            <div class="modal-content fullscreen-content">
                <div class="modal-header">
                    <h3>
                        <i class="material-icons">terminal</i>
                        Node Commands
                    </h3>
                    <button class="modal-close" onclick="closeCommandsModal()">
                        <i class="material-icons">close</i>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Tabs -->
                    <div class="custom-tabs">
                        <button class="custom-tab-button active" data-tab="block-operations">
                            <i class="material-icons">block</i>
                            Block Operations
                        </button>
                        <button class="custom-tab-button" data-tab="database-operations" onclick="preFillDatabaseOperationsTab()">
                            <i class="material-icons">storage</i>
                            Database Operations
                        </button>
                        <button class="custom-tab-button" data-tab="compact-storage">
                            <i class="material-icons">compress</i>
                            Compact Storage
                        </button>
                    </div>

                    <!-- Tab Content -->
                    <div class="custom-tab-content">
                        <!-- Block Operations Tab -->
                        <div id="block-operations" class="custom-tab-pane active">
                            <div class="commands-section">
                                <h4>Block Operations</h4>
                                
                                <!-- Rollback Command -->
                                <div class="command-item">
                                    <div class="command-header">
                                        <span class="command-title">Rollback One Block</span>
                                        <span class="command-description">Rollback the latest block and delete its state</span>
                                    </div>
                                    <button id="rollback-btn" class="button danger" onclick="executeRollback()">
                                        <i class="material-icons">undo</i>
                                        Execute Rollback
                                    </button>
                                    <div id="rollback-logs" class="command-logs" style="display: none;">
                                        <div class="logs-header">
                                            <span>Rollback Logs</span>
                                            <button class="button tertiary small" style="float: right;" onclick="clearRollbackLogs()">
                                                <i class="material-icons">clear</i>
                                                Clear
                                            </button>
                                        </div>
                                        <div class="logs-content">
                                            <pre id="rollback-output"></pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Database Operations Tab -->
                        <div id="database-operations" class="custom-tab-pane">
                            <div class="commands-section">
                                <h4>Database Operations</h4>
                                
                                <!-- Application DB Info Command -->
                                <div class="command-item">
                                    <div class="command-header">
                                        <span class="command-title">Application DB Info</span>
                                        <span class="command-description">Get information about a specific block height</span>
                                    </div>
                                    <div class="command-input-group">
                                        <label for="block-height">Block Height:</label>
                                        <input type="number" id="block-height" class="form-control" placeholder="Enter block height">
                                        <button id="db-info-btn" class="button primary" onclick="executeDbInfo()">
                                            <i class="material-icons">info</i>
                                            Get Info
                                        </button>
                                    </div>
                                    <div id="db-info-logs" class="command-logs" style="display: none;">
                                        <div class="logs-header">
                                            <span>DB Info Output</span>
                                            <button class="button tertiary small" style="float: right;" onclick="clearDbInfoLogs()">
                                                <i class="material-icons">clear</i>
                                                Clear
                                            </button>
                                        </div>
                                        <div class="logs-content">
                                            <pre id="db-info-output"></pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Compact Storage Tab -->
                        <div id="compact-storage" class="custom-tab-pane">
                            <div class="commands-section">
                                <h4>Compact Storage</h4>
                                
                                <!-- Compact Storage Command -->
                                <div class="command-item">
                                    <div class="command-header">
                                        <span class="command-title">Compact Storage</span>
                                        <span class="command-description">Compact application database and experimental GoLevelDB storage</span>
                                    </div>
                                    <button id="compact-storage-btn" class="button primary" onclick="executeCompactStorage()">
                                        <i class="material-icons">compress</i>
                                        Execute Compact Storage
                                    </button>
                                    <div id="compact-storage-logs" class="command-logs" style="display: none;">
                                        <div class="logs-header">
                                            <span>Compact Storage Logs</span>
                                            <button class="button tertiary small" style="float: right;" onclick="clearCompactStorageLogs()">
                                                <i class="material-icons">clear</i>
                                                Clear
                                            </button>
                                        </div>
                                        <div class="logs-content">
                                            <pre id="compact-storage-output"></pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="button secondary" onclick="closeCommandsModal()">
                        <i class="material-icons">close</i>
                        Close
                    </button>
                </div>
            </div>
        </div>
        <script>
            let password = window.localStorage.getItem("access-code");

            async function startNode1(btn) {
                btn.disabled = true;

                let result = await fetch('/run-miner-node', {
                        method: 'POST',
                        headers: {
                            'Access-Code': password,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({})
                    });
                let jsonResult = await result.json();
            }

            async function restartNode1(button) {
                button.disabled = true;
                button.querySelector("span").innerText = "Restarting...";
                
                fetch("/restart-node", {
                        method: 'POST',
                        headers: {
                            'Access-Code': password,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({})
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error("Error while attempting to restart!");
                        }
                        return response.text();
                    })
                    .then(message => {
                        button.querySelector("span").innerText = "Restart";
                    })
                    .catch(error => {
                        console.error("Restart error:", error);
                        button.querySelector("span").innerText = "Restart";
                    })
                    .finally(() => {
                        button.disabled = false;
                    });
            }

            async function startEthStats(btn) {
                btn.disabled = true;

                let inputEthStatsServerUrl = document.getElementById('ethStats-server-url');
                let inputEthStatsNodeName = document.getElementById('ethStats-node-name');

                let result = await fetch('/run-ethstats', {
                        method: 'POST',
                        headers: {
                            'Access-Code': password,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            ethStatsServerUrl: inputEthStatsServerUrl.value,
                            ethStatsNodeName: inputEthStatsNodeName.value
                        })
                    });
                let jsonResult = await result.json();
            }

            async function stopNode1(btn) {
                btn.disabled = true;
                let result = await fetch('/stop-node', {
                    method: 'POST',
                    headers: {
                        'Access-Code': password,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
            }

            async function stopEthStats(btn) {
                btn.disabled = true;
                let result = await fetch('/ethstats-kill', {
                    method: 'POST',
                    headers: {
                        'Access-Code': password,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
            }

            async function addNewPeer(btn) {
                btn.disabled = true;

                const functionToCall = async (address) => {
                    const result = await apiAddPeer(address);
                    if (result) {
                        btn.disabled = false;
                    } else {
                        window.alert("Failed to add peer");
                    }
                }

                window.pw_prompt({
                    lm: "Enter the peer address:",
                    callback: async (address) => {
                        functionToCall(address);
                    }
                });
            }

            function showMoreOptions() {
                const modal = document.getElementById('commands-modal');
                modal.style.display = 'flex';
            }

            function copyAddress() {
                const addressText = document.getElementById('address-text').dataset.fullAddress;
                navigator.clipboard.writeText(addressText).then(() => {
                    const addressContainer = document.getElementById('node-address');
                    addressContainer.style.backgroundColor = '#e0f7fa';
                    setTimeout(() => {
                        addressContainer.style.backgroundColor = '';
                    }, 300);
                });
            }

            function copyMyPeerId() {
                const peerId = document.getElementById('my-peer-id').textContent;
                if (peerId && peerId !== 'Loading...') {
                    navigator.clipboard.writeText(peerId).then(() => {
                        showCopyFeedback('my-peer-id');
                    });
                }
            }

            function copyPeerAddress(peerAddress) {
                navigator.clipboard.writeText(peerAddress).then(() => {
                    showCopyFeedback(peerAddress);
                });
            }

            function showCopyFeedback(elementId) {
                const element = document.getElementById(elementId);
                if (element) {
                    const originalBackground = element.style.backgroundColor;
                    element.style.backgroundColor = '#4CAF50';
                    element.style.color = 'white';
                    setTimeout(() => {
                        element.style.backgroundColor = originalBackground;
                        element.style.color = '';
                    }, 500);
                }
            }

            function createPeerCard(peer, type) {
                const card = document.createElement('div');
                card.className = 'peer-card';
                card.setAttribute('data-peer', peer);
                
                // Extract peer ID and address from the peer string
                const peerParts = peer.split('@');
                const peerId = peerParts[0] || peer;
                const peerAddress = peerParts[1] || '';
                
                // Create actions HTML - only show delete button for persistent peers
                const actionsHtml = `
                    ${type === 'persistent' ? `
                        <button class="button danger small" onclick="removePeer('${peer}', '${type}')" title="Remove Peer">
                            <span class="material-icons">delete</span>
                        </button>
                    ` : ''}
                `;
                
                card.innerHTML = `
                    <div class="peer-copy">
                        <button class="button tertiary small" onclick="copyPeerAddress('${peer}')" title="Copy Peer Address">
                            <span class="material-icons">content_copy</span>
                        </button>
                    </div>
                    <div class="peer-info">
                        <div class="peer-address" title="${peerId}@${peerAddress}">${peerId}@${peerAddress}</div>
                    </div>
                     <div class="peer-actions">
                        ${actionsHtml}
                    </div>
                `;
                
                return card;
            }

            // Simple notification function
            function showNotification(type, title, message, duration = 5000) {
                // Create notification element
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : type === 'warning' ? '#ff9800' : '#2196F3'};
                    color: white;
                    padding: 1rem;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 10000;
                    max-width: 300px;
                    font-size: 0.9rem;
                `;
                
                notification.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 0.5rem;">${title}</div>
                    <div>${message}</div>
                `;
                
                document.body.appendChild(notification);
                
                // Auto remove after duration
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, duration);
            }

            async function removePeer(peer, type) {
                if (confirm(`Are you sure you want to remove this ${type} peer?\n\n${peer}`)) {
                    try {
                        const response = await fetch('/remove-peer', {
                            method: 'POST',
                            headers: {
                                'Access-Code': password,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                peerAddress: peer
                            })
                        });

                        if (response.ok) {
                            const data = await response.json();
                            if (data.success) {
                                showNotification('success', 'Success', `Peer removed successfully`);
                            } else {
                                showNotification('error', 'Error', `Failed to remove peer: ${data.error}`);
                            }
                        } else {
                            showNotification('error', 'Error', 'Failed to remove peer');
                        }
                    } catch (error) {
                        console.error('Error removing peer:', error);
                        showNotification('error', 'Error', 'Error removing peer');
                    }
                }
            }

            // Modal and Commands Functions
            function closeCommandsModal() {
                const modal = document.getElementById('commands-modal');
                modal.style.display = 'none';
            }

            async function executeRollback() {
                if (!confirm('Are you sure you want to rollback one block? This action cannot be undone.')) {
                    return;
                }

                const button = document.getElementById('rollback-btn');
                const logsContainer = document.getElementById('rollback-logs');
                const output = document.getElementById('rollback-output');

                // Disable button and show logs
                button.disabled = true;
                button.innerHTML = '<i class="material-icons">hourglass_empty</i> Executing...';
                logsContainer.style.display = 'block';
                output.textContent = 'Executing rollback command...\n';

                try {
                    const response = await fetch('/execute-rollback', {
                        method: 'POST',
                        headers: {
                            'Access-Code': password,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({})
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            output.textContent += data.output || 'Rollback completed successfully.\n';
                        } else {
                            output.textContent += `Error: ${data.error}\n`;
                        }
                    } else {
                        output.textContent += 'Error: Failed to execute rollback command.\n';
                    }
                } catch (error) {
                    console.error('Error executing rollback:', error);
                    output.textContent += `Error: ${error.message}\n`;
                } finally {
                    // Re-enable button
                    button.disabled = false;
                    button.innerHTML = '<i class="material-icons">undo</i> Execute Rollback';
                }
            }

            async function executeDbInfo() {
                const blockHeight = document.getElementById('block-height').value;
                const button = document.getElementById('db-info-btn');
                const logsContainer = document.getElementById('db-info-logs');
                const output = document.getElementById('db-info-output');

                // Disable button and show logs
                button.disabled = true;
                button.innerHTML = '<i class="material-icons">hourglass_empty</i> Executing...';
                logsContainer.style.display = 'block';
                output.textContent = 'Executing DB info command...\n';

                try {
                    const response = await fetch('/execute-db-info', {
                        method: 'POST',
                        headers: {
                            'Access-Code': password,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            height: blockHeight || 'latest'
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            output.textContent += data.output || 'DB info retrieved successfully.\n';
                        } else {
                            output.textContent += `Error: ${data.error}\n`;
                        }
                    } else {
                        output.textContent += 'Error: Failed to execute DB info command.\n';
                    }
                } catch (error) {
                    console.error('Error executing DB info:', error);
                    output.textContent += `Error: ${error.message}\n`;
                } finally {
                    // Re-enable button
                    button.disabled = false;
                    button.innerHTML = '<i class="material-icons">info</i> Get Info';
                }
            }

            function clearRollbackLogs() {
                document.getElementById('rollback-output').textContent = '';
                document.getElementById('rollback-logs').style.display = 'none';
            }

            function clearDbInfoLogs() {
                document.getElementById('db-info-output').textContent = '';
                document.getElementById('db-info-logs').style.display = 'none';
            }

            async function executeCompactStorage() {
                const button = document.getElementById('compact-storage-btn');
                const logsContainer = document.getElementById('compact-storage-logs');
                const output = document.getElementById('compact-storage-output');

                // Disable button and show logs
                button.disabled = true;
                button.innerHTML = '<i class="material-icons">hourglass_empty</i> Executing...';
                logsContainer.style.display = 'block';
                output.textContent = 'Executing compact storage commands...\n';

                try {
                    // Execute first command: heliades application-db compact
                    output.textContent += 'Step 1: Compacting application database...\n';
                    const response1 = await fetch('/execute-compact-application-db', {
                        method: 'POST',
                        headers: {
                            'Access-Code': password,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({})
                    });

                    if (response1.ok) {
                        const data1 = await response1.json();
                        if (data1.success) {
                            output.textContent += data1.output || 'Application database compacted successfully.\n';
                        } else {
                            output.textContent += `Error: ${data1.error}\n`;
                        }
                    } else {
                        output.textContent += 'Error: Failed to compact application database.\n';
                    }

                    // Execute second command: heliades experimental-compact-goleveldb
                    // output.textContent += '\nStep 2: Compacting experimental GoLevelDB...\n';
                    // const response2 = await fetch('/execute-compact-goleveldb', {
                    //     method: 'POST',
                    //     headers: {
                    //         'Access-Code': password,
                    //         'Content-Type': 'application/json'
                    //     },
                    //     body: JSON.stringify({})
                    // });

                    // if (response2.ok) {
                    //     const data2 = await response2.json();
                    //     if (data2.success) {
                    //         output.textContent += data2.output || 'Experimental GoLevelDB compacted successfully.\n';
                    //     } else {
                    //         output.textContent += `Error: ${data2.error}\n`;
                    //     }
                    // } else {
                    //     output.textContent += 'Error: Failed to compact experimental GoLevelDB.\n';
                    // }

                    output.textContent += '\nCompact storage operation completed.\n';
                } catch (error) {
                    console.error('Error executing compact storage:', error);
                    output.textContent += `Error: ${error.message}\n`;
                } finally {
                    // Re-enable button
                    button.disabled = false;
                    button.innerHTML = '<i class="material-icons">compress</i> Execute Compact Storage';
                }
            }

            function clearCompactStorageLogs() {
                document.getElementById('compact-storage-output').textContent = '';
                document.getElementById('compact-storage-logs').style.display = 'none';
            }

            function preFillDatabaseOperationsTab() {
                const blockHeightInput = document.getElementById('block-height');
                const nodeHeight = document.getElementById('node-height');
                if (blockHeightInput && nodeHeight && !isNaN(blockHeightInput.value)) {
                    blockHeightInput.value = Number(nodeHeight.textContent);
                }
            }

            function switchTab(tabName) {
                // Hide all tab panes
                const tabPanes = document.querySelectorAll('.tab-pane');
                tabPanes.forEach(pane => {
                    pane.classList.remove('active');
                });

                // Remove active class from all tab buttons
                const tabButtons = document.querySelectorAll('.tab-button');
                tabButtons.forEach(button => {
                    button.classList.remove('active');
                });

                // Show selected tab pane
                const selectedPane = document.getElementById(tabName);
                if (selectedPane) {
                    selectedPane.classList.add('active');
                }

                // Add active class to clicked button
                const clickedButton = event.target.closest('.tab-button');
                if (clickedButton) {
                    clickedButton.classList.add('active');
                }
            }

            // Cache previous state to avoid unnecessary DOM work
            let lastAddrbookPeers = '';
            let lastPersistentPeers = '';

            const main = async () => {
                if (password == undefined) {
                    window.location = '/';
                    return ;
                }

                if (!(await apiTestPassword(password))) {
                    window.localStorage.removeItem('access-code');
                    window.location = '/';
                    return ;
                }
                displaySideBar();

                document.querySelectorAll('.main-content')[0].style.display = '';

                const setup = await isSetup();

                if (setup) {
                    let isPaused = false;
                    const pauseButton = document.getElementById('pause-logs');
                    const logsContainer = document.getElementById('node1-logs');
                    
                    pauseButton.onclick = () => {
                        isPaused = !isPaused;
                        pauseButton.textContent = isPaused ? 'Resume' : 'Pause';
                        if (isPaused) {
                            logsContainer.style.border = '1px solid orange';
                        } else {
                            logsContainer.style.border = '';
                        }
                    };

                    setInterval(async () => {
                        let result = await fetch('/test', {
                            method: 'POST',
                            headers: {
                                'Access-Code': password
                            },
                            body: JSON.stringify({})
                        });
                        let jsonResult = await result.json();

                        const pre = logsContainer.querySelector('pre');
                        if (pre && !isPaused) {
                            const newContent = jsonResult.node.logs.join('\n');
                            if (pre.innerHTML !== newContent) {
                                pre.innerHTML = newContent;
                                if (!document.activeElement.isEqualNode(pre) && !document.activeElement.isEqualNode(logsContainer)) {
                                    logsContainer.scrollTop = logsContainer.scrollHeight;
                                }
                            }
                        }

                        const btnStart = document.getElementById('btnStart');
                        const btnStop = document.getElementById('btnStop');
                        if (btnStart) btnStart.disabled = jsonResult.node.status == '1';
                        if (btnStop) btnStop.disabled = jsonResult.node.status == '0';

                        const active = jsonResult.node.status == '1' ? 'Active' : 'Inactive';
                        const syncing = jsonResult.node.infos?.sync_info?.catching_up == true;
                        const statusBadge = document.getElementById('node-status-badge');
                        if (statusBadge) {
                            const statusText = `${active} - ${jsonResult.node?.infos?.mode ?? ''} - Block ${jsonResult.node?.infos?.metadata?.height ?? ''}` + (syncing ? ' (Syncing)' : '');
                            statusBadge.textContent = statusText;
                            statusBadge.className = `status-badge ${active.toLowerCase()}`;
                        }

                        const nodeMode = document.getElementById('node-mode');
                        if (nodeMode) {
                            nodeMode.textContent = jsonResult.node?.infos?.mode ?? 'N/A';
                        }

                        const nodeHeight = document.getElementById('node-height');
                        if (nodeHeight) {
                            nodeHeight.textContent = jsonResult.node?.infos?.metadata?.height ?? 'N/A';
                        }

                        const nodeSync = document.getElementById('node-sync');
                        if (nodeSync) {
                            nodeSync.textContent = syncing ? 'Syncing' : 'Up to date';
                            nodeSync.classList.remove('is-warning', 'is-success');
                            nodeSync.classList.add(syncing ? 'is-warning' : 'is-success');
                        }

                        const addressText = document.getElementById('address-text');
                        if (addressText) {
                            const fullAddress = jsonResult.node?.infos?.address || 'N/A';
                            addressText.textContent = truncateMiddle(fullAddress, 30);
                            addressText.dataset.fullAddress = fullAddress; // Store full address in a data attribute
                        }

                        // Update My Node Info
                        const myPeerId = document.getElementById('my-peer-id');
                        const peersBadge = document.getElementById('peers-badge');
                        
                        if (myPeerId && jsonResult.node.infos?.node_info?.id) {
                            const url = window.location.href;
                            const ValidIpAddressRegex = new RegExp("^(25[0-5]|2[0-4]\\d|[0-1]?\\d?\\d)(\\.(25[0-5]|2[0-4]\\d|[0-1]?\\d?\\d)){3}$");

                            let ip = ValidIpAddressRegex.exec(url);
                            console.log(jsonResult.node.infos);
                            if (ip == undefined) {
                                ip = '0.0.0.0';
                            }

                            //listen_addr: "tcp://0.0.0.0:26656"
                            const parsedPortFromListenAddr = jsonResult.node.infos.node_info.listen_addr.split(':')[2];
                            myPeerId.textContent = `${jsonResult.node.infos.node_info.id}@${ip}:${parsedPortFromListenAddr}`;
                        } else {
                            myPeerId.textContent = 'Loading...';
                        }
                        
                        // if (peersBadge && jsonResult.node.infos?.node_info?.id) {
                        //     peersBadge.textContent = 'Connected';
                        //     peersBadge.className = 'status-badge active';
                        // }

                        // Update AddrBook Peers
                        if (jsonResult.node.infos?.peers) {
                            const addrbookPeers = document.getElementById('addrbook-peers');
                            const addrbookCount = document.getElementById('addrbook-count');
                            if (addrbookCount) {
                                addrbookCount.textContent = `(${jsonResult.node.infos.peers.length})`;
                            }
                            if (addrbookPeers) {
                                const peersString = JSON.stringify(jsonResult.node.infos.peers);
                                if (peersString !== lastAddrbookPeers) {
                                    lastAddrbookPeers = peersString;
                                    if (jsonResult.node.infos.peers.length > 0) {
                                        addrbookPeers.innerHTML = '';
                                        jsonResult.node.infos.peers.forEach(peer => {
                                            const peerCard = createPeerCard(peer, 'addrbook');
                                            addrbookPeers.appendChild(peerCard);
                                        });
                                    } else {
                                        addrbookPeers.innerHTML = `
                                            <div class="no-peers">
                                                <span class="material-icons">group_off</span>
                                                <p>No AddrBook peers connected</p>
                                            </div>
                                        `;
                                    }
                                }
                            }
                        }
                        // Update Persistent Peers
                        if (jsonResult.node.infos?.persistentPeers) {
                            const persistentPeers = document.getElementById('persistent-peers');
                            const persistentCount = document.getElementById('persistent-count');
                            if (persistentCount) {
                                persistentCount.textContent = `(${jsonResult.node.infos.persistentPeers.length})`;
                            }
                            if (persistentPeers) {
                                const peersString = JSON.stringify(jsonResult.node.infos.persistentPeers);
                                if (peersString !== lastPersistentPeers) {
                                    lastPersistentPeers = peersString;
                                    if (jsonResult.node.infos.persistentPeers.length > 0) {
                                        persistentPeers.innerHTML = '';
                                        jsonResult.node.infos.persistentPeers.forEach(peer => {
                                            const peerCard = createPeerCard(peer, 'persistent');
                                            persistentPeers.appendChild(peerCard);
                                        });
                                    } else {
                                        persistentPeers.innerHTML = `
                                            <div class="no-peers">
                                                <span class="material-icons">link_off</span>
                                                <p>No persistent peers configured</p>
                                            </div>
                                        `;
                                    }
                                }
                            }
                        }
                    }, 1000);
                } else {
                    document.getElementById('PageSetup').style.display = 'block';
                }
            }

            window.addEventListener('DOMContentLoaded', async (event) => {
                await main();
            });

            // Custom Tabs JavaScript
            document.addEventListener('DOMContentLoaded', function() {
                const tabButtons = document.querySelectorAll('.custom-tab-button');
                const tabPanes = document.querySelectorAll('.custom-tab-pane');
                
                tabButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const targetTab = this.getAttribute('data-tab');
                        
                        // Remove active class from all buttons and panes
                        tabButtons.forEach(btn => btn.classList.remove('active'));
                        tabPanes.forEach(pane => pane.classList.remove('active'));
                        
                        // Add active class to clicked button and target pane
                        this.classList.add('active');
                        document.getElementById(targetTab).classList.add('active');
                    });
                });
            });

        </script>
        <script src="js/theme.js"></script>
        <script src="js/side-bar.js"></script>
        <script src="js/utils.js"></script>
        <script src="js/api.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    </body>
</html>
