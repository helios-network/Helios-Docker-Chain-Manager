<html>
    <head>
        <title>Helios Node</title>
        <link rel="icon" type="image/png" href="favicon.png">
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
        <link rel="stylesheet" href="style.css">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>
        <div class="sidebar"></div>

        <!-- Notification Container -->
        <div class="notification-container" id="notification-container"></div>

        <div class="main-content" style="display: none">
            <div class="status-page">
                <section class="status-panels">
                    <!-- Hero Header -->
                    <article class="status-card status-overview-card">
                        <div class="overview-header">
                            <div class="status-hero-text">
                                <span class="status-hero-eyebrow">Wallet Management</span>
                                <h1>My Wallet</h1>
                                <p>View your balance, manage your wallet address, and send transactions to other addresses on the Helios network.</p>
                            </div>
                            <div class="status-hero-meta overview-summary">
                                <div class="summary-item">
                                    <span class="summary-label">Balance</span>
                                    <div class="balance-display" id="hero-balance">
                                        <span class="balance-value">0.00</span>
                                        <span class="balance-currency">HLS</span>
                                    </div>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Wallet Address</span>
                                    <div class="node-address-chip" id="wallet-address-chip">
                                        <span id="wallet-address-short">0x0000...0000</span>
                                        <button class="icon-button" type="button" onclick="copyWalletAddress()" aria-label="Copy wallet address">
                                            <span class="material-icons">content_copy</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </article>


                    <!-- Send Transaction Card -->
                    <article class="status-card">
                        <div class="card-header">
                            <div class="card-title">
                                <span class="material-icons">send</span>
                                <div>
                                    <h2>Send Transaction</h2>
                                    <p>Transfer HLS tokens to another wallet address on the network.</p>
                                </div>
                            </div>
                        </div>
                        <div class="settings-body">
                            <div class="settings-group">
                                <label for="wallet-address-to">Destination Address</label>
                                <input type="text" 
                                       id="wallet-address-to" 
                                       class="form-input"
                                       placeholder="Enter destination address (0x...)" />
                                <p class="help-text">The recipient's wallet address (must start with 0x)</p>
                            </div>

                            <div class="settings-group">
                                <label for="amount-to">Amount (HLS)</label>
                                <input type="number" 
                                       id="amount-to" 
                                       class="form-input"
                                       placeholder="Enter amount to send" 
                                       min="0" 
                                       step="0.000001" />
                                <p class="help-text">Amount of HLS tokens to send</p>
                            </div>

                            <button class="button primary" onclick="sendAction()">
                                <span class="material-icons">send</span>
                                Send Transaction
                            </button>
                        </div>
                    </article>
                </section>
            </div>
        </div>
        <script>
            let password = window.localStorage.getItem("access-code");

            const showNotification = (type, title, message, duration = 5000) => {
                const container = document.getElementById('notification-container');
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                
                const iconMap = {
                    success: 'check_circle',
                    error: 'error',
                    warning: 'warning',
                    info: 'info'
                };
                
                notification.innerHTML = `
                    <div class="notification-icon">
                        <span class="material-icons">${iconMap[type] || 'info'}</span>
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">${title}</div>
                        <div class="notification-message">${message}</div>
                    </div>
                    <button class="notification-close" onclick="this.parentElement.remove()">
                        <span class="material-icons">close</span>
                    </button>
                    <div class="notification-progress" style="width: 100%"></div>
                `;
                
                container.appendChild(notification);
                
                setTimeout(() => {
                    notification.classList.add('show');
                }, 10);
                
                if (duration > 0) {
                    setTimeout(() => {
                        notification.classList.add('hide');
                        setTimeout(() => {
                            if (notification.parentElement) {
                                notification.remove();
                            }
                        }, 400);
                    }, duration);
                    
                    const progress = notification.querySelector('.notification-progress');
                    progress.style.transition = `width ${duration}ms linear`;
                    setTimeout(() => {
                        progress.style.width = '0%';
                    }, 10);
                }
            };

            function copyWalletAddress() {
                const addressText = document.getElementById('wallet-address-full').textContent;
                navigator.clipboard.writeText(addressText).then(() => {
                    const addressChip = document.getElementById('wallet-address-chip');
                    const originalBackground = addressChip.style.backgroundColor;
                    
                    addressChip.style.backgroundColor = 'rgba(46, 204, 113, 0.2)';
                    addressChip.style.borderColor = 'rgba(46, 204, 113, 0.3)';
                    
                    showNotification('success', 'Copied!', 'Wallet address copied to clipboard');
                    
                    setTimeout(() => {
                        addressChip.style.backgroundColor = originalBackground;
                        addressChip.style.borderColor = '';
                    }, 2000);
                });
            }

            async function sendAction() {
                const amount = document.getElementById('amount-to').value;
                const addressTo = document.getElementById('wallet-address-to').value;
                
                if (!amount || amount <= 0) {
                    showNotification('error', 'Invalid Amount', 'Please enter a valid amount greater than 0');
                    return;
                }
                
                if (!addressTo || addressTo.trim() === '') {
                    showNotification('error', 'Invalid Address', 'Please enter a valid destination address');
                    return;
                }
                
                // Basic address validation
                if (!addressTo.startsWith('0x') || addressTo.length !== 42) {
                    showNotification('error', 'Invalid Address Format', 'Please enter a valid Ethereum-style address (0x... with 42 characters)');
                    return;
                }
                
                const walletPassword = await new Promise((resolve) => {
                    try {
                        pw_prompt({
                            lm: "Please enter your wallet password:", 
                            callback: function(password) {
                                resolve(password);
                            }
                        });
                    } catch (e) {
                        resolve('');
                    }
                });
                
                if (!walletPassword) {
                    showNotification('error', 'Password Required', 'Password is required to send transaction');
                    return;
                }
                
                const walletData = {
                    to: addressTo,
                    amount: amount
                };
                
                showNotification('info', 'Processing', 'Sending transaction...');
                
                const result = await apiWalletTransfer(walletPassword, walletData);
                if (result.error) {
                    showNotification('error', 'Transaction Failed', result.error);
                    return;
                }
                
                showNotification('success', 'Transaction Successful!', `Transaction hash: ${result.hash}`);
                
                document.getElementById('amount-to').value = '';
                document.getElementById('wallet-address-to').value = '';
                
                await updateWalletInfo();
            }

            async function updateWalletInfo() {
                try {
                    const wallet = await apiGetWalletInfo();
                    
                    if (wallet && wallet !== false && wallet.address) {
                        const balance = wallet.balance || '0.00';
                        const address = wallet.address;

                        document.getElementById('hero-balance').querySelector('.balance-value').textContent = balance;
                        document.getElementById('wallet-address-short').textContent = address;
                    } else {
                        console.log('Wallet info not available - node may be offline');
                    }
                } catch (error) {
                    console.error('Error updating wallet info:', error);
                }
            }

            const main = async () => {
                if (password == undefined) {
                    window.location = '/';
                    return ;
                }
                if (!(await isSetup())) {
                    window.location = '/setup';
                    return ;
                }
                displaySideBar();
                document.querySelectorAll('.main-content')[0].style.display = '';

                await updateWalletInfo();
                
                setInterval(async () => {
                    await updateWalletInfo();
                }, 10000);
            }

            window.addEventListener('DOMContentLoaded', async (event) => {
                await main();
            });
        </script>
        <script src="js/theme.js"></script>
        <script src="js/side-bar.js"></script>
        <script src="js/utils.js"></script>
        <script src="js/api.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    </body>
</html>