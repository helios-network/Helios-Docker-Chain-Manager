<html>
    <head>
        <title>Helios Node - Backups</title>
        <link rel="icon" type="image/png" href="favicon.png">
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
        <link rel="stylesheet" href="style.css">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>
        <div class="sidebar"></div>

        <!-- Notification Container -->
        <div class="notification-container" id="notification-container"></div>

        <div class="main-content" style="display: none">
            <!-- Notification Container -->
            <div class="notification-container" id="notification-container"></div>

            <div class="status-page">
                <section class="status-panels">
                    <!-- Hero Header -->
                    <article class="status-card status-overview-card">
                        <div class="overview-header">
                            <div class="status-hero-text">
                                <span class="status-hero-eyebrow">Data Protection</span>
                                <h1>Backup Management</h1>
                                <p>Create, restore, and manage blockchain data backups. Access managed Helios snapshots hosted by our infrastructure.</p>
                            </div>
                            <div class="status-hero-meta overview-summary">
                                <div class="summary-item">
                                    <button id="create-backup" class="button primary" onclick="showCreateBackupModal()">
                                        <span class="material-icons">add</span>
                                        Create Backup
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="node-actions overview-body">
                            <div class="node-controls">
                                <div class="controls-header">
                                    <span class="material-icons">cloud</span>
                                    <div>
                                        <h3>Quick Actions</h3>
                                        <p>Manage local backups and hosted Helios snapshots.</p>
                                    </div>
                                </div>
                                <div class="node-action-buttons">
                                    <button id="refresh-backups" class="button secondary" onclick="loadBackups()">
                                        <span class="material-icons">refresh</span>
                                        Refresh Local
                                    </button>
                                    <button id="refresh-remote-snapshots" class="button tertiary" onclick="loadRemoteSnapshots(true)">
                                        <span class="material-icons">cloud_download</span>
                                        Refresh Snapshots
                                    </button>
                                    <button id="open-snapshot-portal" class="button tertiary" onclick="openSnapshotsPortal()">
                                        <span class="material-icons">open_in_new</span>
                                        Snapshot Portal
                                    </button>
                                </div>
                            </div>
                        </div>
                    </article>

                    <!-- Remote Snapshots Card -->
                    <article class="status-card">
                        <div class="card-header">
                            <div class="card-title">
                                <span class="material-icons">cloud_queue</span>
                                <div>
                                    <h2>Hosted Snapshots</h2>
                                    <p>Browse Helios snapshots ready to download and apply.</p>
                                </div>
                            </div>
                            <div class="card-actions">
                                <button class="button tertiary small" onclick="loadRemoteSnapshots(true)">
                                    <span class="material-icons">refresh</span>
                                    Refresh
                                </button>
                            </div>
                        </div>
                        <div class="settings-body">
                            <div id="remote-snapshots-container">
                                <div id="remote-snapshots-loading" class="loading-container">
                                    <div class="spinner-border"></div>
                                    <p>Loading snapshots...</p>
                                </div>
                                <div id="remote-snapshots-table" style="display: none;">
                                    <div class="table-responsive">
                                        <table class="backups-table">
                                            <thead>
                                                <tr>
                                                    <th>Block ID</th>
                                                    <th>Uploaded</th>
                                                    <th>Snapshot</th>
                                                    <th>Size</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="remote-snapshots-table-body"></tbody>
                                        </table>
                                    </div>
                                </div>
                                <div id="remote-snapshots-empty" style="display: none;">
                                    <div class="empty-state">
                                        <span class="material-icons">cloud_off</span>
                                        <h3>No snapshots available</h3>
                                        <p>We could not load hosted snapshots right now. Try refreshing or open the snapshot portal.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </article>

                    <!-- Backups List Card -->
                    <article class="status-card">
                        <div class="card-header">
                            <div class="card-title">
                                <span class="material-icons">backup</span>
                                <div>
                                    <h2>Backup Files</h2>
                                    <p>View and manage your local blockchain backups.</p>
                                </div>
                            </div>
                        </div>
                        <div class="settings-body">
                            <div id="backups-table-container">
                                <div id="loading-backups" class="loading-container">
                                    <div class="spinner-border"></div>
                                    <p>Loading backups...</p>
                                </div>
                                <div id="backups-table" style="display: none;">
                                    <div class="table-responsive">
                                        <table class="backups-table">
                                            <thead>
                                                <tr>
                                                    <th>Block ID</th>
                                                    <th>Date & Time</th>
                                                    <th>Filename</th>
                                                    <th>Size</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="backups-table-body">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div id="no-backups" style="display: none;">
                                    <div class="empty-state">
                                        <span class="material-icons">folder_open</span>
                                        <h3>No backup files found</h3>
                                        <p>Backup files will appear here once the backup system is enabled and has created some backups.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </article>
                </section>
            </div>
        </div>

        <!-- Apply Backup Modal -->
        <div id="apply-backup-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>
                        <span class="material-icons">warning</span>
                        Apply Backup
                    </h3>
                    <button class="modal-close" onclick="hideApplyBackupModal()">
                        <span class="material-icons">close</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="warning-message">
                        <p><strong>Warning:</strong> This action will replace your current blockchain data with the selected backup.</p>
                        <p>This operation will:</p>
                        <ul>
                            <li>Stop the current node</li>
                            <li>Delete your current data directory</li>
                            <li>Extract the backup data</li>
                            <li>Reset validator state</li>
                        </ul>
                    </div>
                    
                    <div class="backup-info">
                        <h4>Selected Backup:</h4>
                        <p><strong>Filename:</strong> <span id="modal-filename"></span></p>
                        <p><strong>Block Height:</strong> <span id="modal-block-height"></span></p>
                    </div>
                    
                    <div class="backup-option">
                        <label class="checkbox-label">
                            <input type="checkbox" id="backup-current-data" checked>
                            <span class="checkmark"></span>
                            Backup current data before applying backup
                        </label>
                        <p class="option-description">This will create a backup of your current data before replacing it with the backup.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="button danger" onclick="applyBackup()">
                        <span class="material-icons">restore</span>
                        Apply Backup
                    </button>
                </div>
            </div>
        </div>

        <!-- Create Backup Modal -->
        <div id="create-backup-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>
                        <span class="material-icons">backup</span>
                        Create Backup
                    </h3>
                    <button class="modal-close" onclick="hideCreateBackupModal()">
                        <span class="material-icons">close</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="backup-preview-content">
                        <div class="info-message">
                            <p>This will create a comprehensive backup of your current blockchain data and configuration.</p>
                            <p>The backup will include:</p>
                            <ul>
                                <li><strong>Blockchain Data:</strong> application.db, state.db, blockstore.db</li>
                                <li><strong>Configuration:</strong> genesis.json, addrbook.json, config.toml, node keys</li>
                                <li><strong>Metadata:</strong> metadata.json, settings.json</li>
                                <li><strong>Network:</strong> persistent peers configuration</li>
                            </ul>
                        </div>
                        
                        <div class="backup-preview">
                            <h4>Backup Preview:</h4>
                            <div id="backup-preview-info">
                                <!-- Content will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                    
                    <div id="backup-error-content" style="display: none;">
                        <div class="error-message">
                            <span class="material-icons">error</span>
                            <h4>No backup possible</h4>
                            <p>The blockchain has not been initialized yet. Please start the node first to create a backup.</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="confirm-create-backup" class="button primary" onclick="confirmCreateBackup()" style="display: none;">
                        <span class="material-icons">backup</span>
                        Create Backup
                    </button>
                </div>
            </div>
        </div>

        <!-- Delete Backup Modal -->
        <div id="delete-backup-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>
                        <span class="material-icons">delete</span>
                        Delete Backup
                    </h3>
                    <button class="modal-close" onclick="hideDeleteBackupModal()">
                        <span class="material-icons">close</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="warning-message">
                        <p><strong>Warning:</strong> This action will permanently delete the selected backup file.</p>
                        <p>This operation cannot be undone.</p>
                    </div>
                    
                    <div class="backup-info">
                        <h4>Backup to Delete:</h4>
                        <p><strong>Filename:</strong> <span id="delete-modal-filename"></span></p>
                        <p><strong>Block Height:</strong> <span id="delete-modal-block-height"></span></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="button danger" onclick="confirmDeleteBackup()">
                        <span class="material-icons">delete</span>
                        Delete Backup
                    </button>
                </div>
            </div>
        </div>

        <div id="snapshotProgressOverlay" class="progress-overlay" style="display:none;">
            <div class="progress-card" role="dialog" aria-live="polite" aria-atomic="true">
                <div class="progress-header">
                    <div class="progress-spinner"></div>
                    <div class="progress-texts">
                        <div id="snapshotProgressTitle" class="progress-title">Preparing snapshot download…</div>
                        <div id="snapshotProgressDetails" class="progress-details">Connecting to Helios snapshot service.</div>
                    </div>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="snapshot-progress-bar" aria-hidden="true">
                        <div class="progress-bar-inner" id="snapshot-progress-bar-inner"></div>
                        <div class="progress-bar-determinate" id="snapshot-progress-bar-fill"></div>
                    </div>
                </div>
                <div class="progress-meta">
                    <div class="progress-kv"><strong>Filename:</strong> <span id="snapshot-progress-filename">-</span></div>
                    <div class="progress-kv"><strong>Transferred:</strong> <span id="snapshot-progress-bytes">0 Bytes</span></div>
                    <div class="progress-kv"><strong>Speed:</strong> <span id="snapshot-progress-speed">--</span></div>
                    <div class="progress-kv"><strong>Progress:</strong> <span id="snapshot-progress-percent">--</span></div>
                </div>
                <div id="snapshot-progress-error" class="error-message" style="display:none;">
                    <span class="material-icons">error</span>
                    <p id="snapshot-progress-error-text"></p>
                </div>
            </div>
        </div>

        <script>
            let password = window.localStorage.getItem("access-code");
            let remoteSnapshots = [];
            const SNAPSHOT_PROGRESS_POLL_INTERVAL = 1500;
            let snapshotDownloadIntervalId = null;
            let snapshotDownloadErrorCount = 0;

            // Notification system
            const showNotification = (type, title, message, duration = 5000) => {
                const container = document.getElementById('notification-container');
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                
                const iconMap = {
                    success: 'check_circle',
                    error: 'error',
                    warning: 'warning',
                    info: 'info'
                };
                
                notification.innerHTML = `
                    <div class="notification-icon">
                        <span class="material-icons">${iconMap[type] || 'info'}</span>
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">${title}</div>
                        <div class="notification-message">${message}</div>
                    </div>
                    <button class="notification-close" onclick="this.parentElement.remove()">
                        <span class="material-icons">close</span>
                    </button>
                    <div class="notification-progress" style="width: 100%"></div>
                `;
                
                container.appendChild(notification);
                
                setTimeout(() => notification.classList.add('show'), 10);
                
                if (duration > 0) {
                    setTimeout(() => {
                        notification.classList.add('hide');
                        setTimeout(() => {
                            if (notification.parentElement) {
                                notification.remove();
                            }
                        }, 400);
                    }, duration);
                    
                    const progress = notification.querySelector('.notification-progress');
                    progress.style.transition = `width ${duration}ms linear`;
                    setTimeout(() => progress.style.width = '0%', 10);
                }
            };

            // Utility functions
            const formatFileSize = (bytes) => {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            };

            const formatBlockId = (blockId) => {
                if (typeof blockId === 'number' && !Number.isNaN(blockId)) {
                    return blockId.toLocaleString();
                }
                const parsed = Number(blockId);
                return Number.isNaN(parsed) ? (blockId || 'Unknown') : parsed.toLocaleString();
            };

            const formatSnapshotDate = (isoString) => {
                if (!isoString) return 'Unknown';
                const date = new Date(isoString);
                if (Number.isNaN(date.getTime())) {
                    return isoString;
                }
                return `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
            };

            const openSnapshotsPortal = () => {
                window.open('https://snapshots.helioschainlabs.org/snapshots/', '_blank', 'noopener');
            };

            const openSnapshotLink = (url) => {
                if (!url) {
                    showNotification('warning', 'Snapshot', 'Download URL not available for this snapshot.');
                    return;
                }
                window.open(url, '_blank', 'noopener');
            };

            const copyToClipboard = async (text, successMessage = 'Copied to clipboard') => {
                if (!text) {
                    showNotification('warning', 'Copy', 'Nothing to copy.');
                    return;
                }

                try {
                    await navigator.clipboard.writeText(text);
                    showNotification('success', 'Copied', successMessage);
                } catch (err) {
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    textarea.style.position = 'fixed';
                    textarea.style.opacity = '0';
                    document.body.appendChild(textarea);
                    textarea.focus();
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        showNotification('success', 'Copied', successMessage);
                    } catch (fallbackError) {
                        showNotification('error', 'Copy Failed', 'Unable to copy to clipboard.');
                    } finally {
                        document.body.removeChild(textarea);
                    }
                }
            };

            const showSnapshotDownloadModal = (snapshot) => {
                const overlay = document.getElementById('snapshotProgressOverlay');
                if (!overlay) {
                    return;
                }

                const titleEl = document.getElementById('snapshotProgressTitle');
                const detailsEl = document.getElementById('snapshotProgressDetails');
                const filenameEl = document.getElementById('snapshot-progress-filename');
                const bytesEl = document.getElementById('snapshot-progress-bytes');
                const speedEl = document.getElementById('snapshot-progress-speed');
                const percentEl = document.getElementById('snapshot-progress-percent');
                const innerBar = document.getElementById('snapshot-progress-bar-inner');
                const determinateBar = document.getElementById('snapshot-progress-bar-fill');
                const bar = document.getElementById('snapshot-progress-bar');
                const errorEl = document.getElementById('snapshot-progress-error');

                if (titleEl) titleEl.textContent = 'Preparing snapshot download…';
                if (detailsEl) detailsEl.textContent = 'Connecting to Helios snapshot service.';
                if (filenameEl) filenameEl.textContent = snapshot?.filename || '-';
                if (bytesEl) bytesEl.textContent = '0 Bytes';
                if (speedEl) speedEl.textContent = '--';
                if (percentEl) percentEl.textContent = '--';
                if (bar) bar.classList.remove('has-progress');
                if (innerBar) innerBar.style.display = '';
                if (determinateBar) determinateBar.style.width = '0%';
                if (errorEl) errorEl.style.display = 'none';

                overlay.classList.remove('hide');
                overlay.style.display = 'flex';
                requestAnimationFrame(() => overlay.classList.add('show'));
            };

            const hideSnapshotDownloadModal = () => {
                const overlay = document.getElementById('snapshotProgressOverlay');
                if (!overlay) {
                    return;
                }
                overlay.classList.remove('show');
                overlay.classList.add('hide');
                setTimeout(() => {
                    overlay.style.display = 'none';
                    overlay.classList.remove('hide');
                }, 200);
            };

            const stopSnapshotDownloadPolling = () => {
                if (snapshotDownloadIntervalId) {
                    clearInterval(snapshotDownloadIntervalId);
                    snapshotDownloadIntervalId = null;
                }
                snapshotDownloadErrorCount = 0;
            };

            const updateSnapshotDownloadModal = (progress) => {
                const overlay = document.getElementById('snapshotProgressOverlay');
                if (!overlay || overlay.style.display === 'none') {
                    return;
                }

                const titleEl = document.getElementById('snapshotProgressTitle');
                const detailsEl = document.getElementById('snapshotProgressDetails');
                const filenameEl = document.getElementById('snapshot-progress-filename');
                const bytesEl = document.getElementById('snapshot-progress-bytes');
                const speedEl = document.getElementById('snapshot-progress-speed');
                const percentEl = document.getElementById('snapshot-progress-percent');
                const bar = document.getElementById('snapshot-progress-bar');
                const innerBar = document.getElementById('snapshot-progress-bar-inner');
                const determinateBar = document.getElementById('snapshot-progress-bar-fill');
                const errorEl = document.getElementById('snapshot-progress-error');
                const errorTextEl = document.getElementById('snapshot-progress-error-text');

                if (filenameEl && progress.filename) {
                    filenameEl.textContent = progress.filename;
                }

                let statusTitle = 'Preparing snapshot download…';
                let statusDetails = 'Setting up transfer.';

                switch (progress.status) {
                    case 'fetching-header':
                        statusTitle = 'Validating snapshot…';
                        statusDetails = 'Fetching snapshot metadata.';
                        break;
                    case 'downloading':
                        statusTitle = 'Downloading snapshot…';
                        statusDetails = 'Transferring snapshot data to your backups directory.';
                        break;
                    case 'finalizing':
                        statusTitle = 'Finalizing snapshot…';
                        statusDetails = 'Securing the snapshot file locally.';
                        break;
                    case 'completed':
                        statusTitle = 'Download complete';
                        statusDetails = 'Snapshot saved to your backups directory.';
                        break;
                    case 'error':
                        statusTitle = 'Download failed';
                        statusDetails = progress.error || 'An error occurred while downloading the snapshot.';
                        break;
                    default:
                        if (progress.stage === 'download') {
                            statusTitle = 'Downloading snapshot…';
                            statusDetails = 'Transferring snapshot data to your backups directory.';
                        } else if (progress.stage === 'finalize') {
                            statusTitle = 'Finalizing snapshot…';
                            statusDetails = 'Securing the snapshot file locally.';
                        }
                }

                if (titleEl) titleEl.textContent = statusTitle;
                if (detailsEl) detailsEl.textContent = statusDetails;

                const downloadedLabel = typeof progress.downloadedBytes === 'number'
                    ? formatFileSize(progress.downloadedBytes)
                    : '0 Bytes';
                const totalLabel = typeof progress.totalBytes === 'number'
                    ? formatFileSize(progress.totalBytes)
                    : null;

                if (bytesEl) {
                    bytesEl.textContent = totalLabel ? `${downloadedLabel} / ${totalLabel}` : downloadedLabel;
                }

                const percent = typeof progress.percent === 'number'
                    ? Math.min(100, progress.percent)
                    : (progress.status === 'completed' ? 100 : null);

                if (percentEl) {
                    percentEl.textContent = percent != null ? `${percent.toFixed(1)}%` : '--';
                }

                if (bar) {
                    if (percent != null) {
                        bar.classList.add('has-progress');
                        if (innerBar) innerBar.style.display = 'none';
                        if (determinateBar) determinateBar.style.width = `${percent}%`;
                    } else {
                        bar.classList.remove('has-progress');
                        if (innerBar) innerBar.style.display = '';
                        if (determinateBar) determinateBar.style.width = '0%';
                    }
                }

                if (speedEl) {
                    if (typeof progress.speedBps === 'number' && progress.speedBps > 0) {
                        speedEl.textContent = `${formatFileSize(progress.speedBps)}/s`;
                    } else if (progress.status === 'completed') {
                        speedEl.textContent = '—';
                    } else {
                        speedEl.textContent = 'Calculating…';
                    }
                }

                if (progress.status === 'error') {
                    if (errorEl) {
                        errorEl.style.display = '';
                        if (errorTextEl) {
                            errorTextEl.textContent = progress.error || 'Snapshot download failed.';
                        }
                    }
                    stopSnapshotDownloadPolling();
                    setTimeout(() => hideSnapshotDownloadModal(), 1800);
                    return;
                }

                if (errorEl) {
                    errorEl.style.display = 'none';
                }

                if (progress.status === 'completed') {
                    stopSnapshotDownloadPolling();
                    setTimeout(() => hideSnapshotDownloadModal(), 1200);
                }
            };

            const startSnapshotDownloadPolling = () => {
                stopSnapshotDownloadPolling();
                snapshotDownloadErrorCount = 0;

                const fetchProgress = async () => {
                    try {
                        const response = await fetch('/download-snapshot/progress', {
                            method: 'GET',
                            headers: {
                                'Access-Code': password,
                                'Content-Type': 'application/json'
                            }
                        });

                        if (response.status === 404) {
                            stopSnapshotDownloadPolling();
                            hideSnapshotDownloadModal();
                            showNotification('info', 'Snapshot Download', 'Realtime download progress is not available on this node.');
                            return;
                        }

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }

                        const progress = await response.json();
                        snapshotDownloadErrorCount = 0;
                        updateSnapshotDownloadModal(progress);
                    } catch (err) {
                        snapshotDownloadErrorCount += 1;
                        if (snapshotDownloadErrorCount >= 3) {
                            stopSnapshotDownloadPolling();
                            hideSnapshotDownloadModal();
                        }
                    }
                };

                fetchProgress();
                snapshotDownloadIntervalId = setInterval(fetchProgress, SNAPSHOT_PROGRESS_POLL_INTERVAL);
            };

            const renderRemoteSnapshots = () => {
                const loadingElement = document.getElementById('remote-snapshots-loading');
                const tableElement = document.getElementById('remote-snapshots-table');
                const emptyElement = document.getElementById('remote-snapshots-empty');
                const tableBody = document.getElementById('remote-snapshots-table-body');

                if (loadingElement) {
                    loadingElement.style.display = 'none';
                }

                if (!Array.isArray(remoteSnapshots) || remoteSnapshots.length === 0) {
                    if (tableElement) tableElement.style.display = 'none';
                    if (emptyElement) emptyElement.style.display = 'block';
                    if (tableBody) tableBody.innerHTML = '';
                    return;
                }

                if (emptyElement) emptyElement.style.display = 'none';
                if (tableElement) tableElement.style.display = 'block';

                if (tableBody) {
                    tableBody.innerHTML = '';

                    remoteSnapshots.forEach(snapshot => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="block-id">${formatBlockId(snapshot.blockId)}</td>
                            <td class="date-time">${formatSnapshotDate(snapshot.uploadedAt)}</td>
                            <td class="filename">
                                <div class="snapshot-filename">${snapshot.filename || 'Unknown snapshot'}</div>
                                ${snapshot.description ? `<div class="snapshot-description">${snapshot.description}</div>` : ''}
                            </td>
                            <td class="file-size">${formatFileSize(snapshot.fileSize || 0)}</td>
                            <td class="actions"></td>
                        `;

                        const actionsCell = row.querySelector('.actions');
                        const downloadUrl = snapshot.downloadUrl;
                        const headerUrl = snapshot.headerUrl;

                        if (actionsCell) {
                            const createActionButton = (icon, title, handler, disabled = false) => {
                                const button = document.createElement('button');
                                button.className = 'button tertiary small';
                                button.title = title;
                                button.innerHTML = `<span class="material-icons">${icon}</span>`;
                                if (disabled) {
                                    button.disabled = true;
                                } else {
                                    button.addEventListener('click', handler);
                                }
                                return button;
                            };

                            const canDownload = !!((headerUrl && headerUrl.length) || (downloadUrl && snapshot.filename));

                            const downloadButton = createActionButton(
                                'download',
                                'Download snapshot to local backups',
                                () => downloadSnapshot(snapshot, downloadButton),
                                !canDownload
                            );
                            actionsCell.appendChild(downloadButton);

                            // actionsCell.appendChild(createActionButton('open_in_new', 'Open download link', () => openSnapshotLink(downloadUrl), !downloadUrl));
                            // actionsCell.appendChild(createActionButton('file_download', 'Copy download URL', () => copyToClipboard(downloadUrl, 'Download URL copied'), !downloadUrl));
                            actionsCell.appendChild(createActionButton('description', 'Copy header URL', () => copyToClipboard(headerUrl, 'Header URL copied'), !headerUrl));
                        }

                        tableBody.appendChild(row);
                    });
                }
            };

            const loadRemoteSnapshots = async (showToast = false) => {
                const loadingElement = document.getElementById('remote-snapshots-loading');
                const tableElement = document.getElementById('remote-snapshots-table');
                const emptyElement = document.getElementById('remote-snapshots-empty');

                if (loadingElement) loadingElement.style.display = 'flex';
                if (tableElement) tableElement.style.display = 'none';
                if (emptyElement) emptyElement.style.display = 'none';

                try {
                    const response = await fetch('/fetch-snapshots', {
                        method: 'GET',
                        headers: {
                            'Access-Code': password,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const data = await response.json();

                    if (data.success && Array.isArray(data.snapshots)) {
                        remoteSnapshots = data.snapshots
                            .map(snapshot => ({
                                ...snapshot,
                                fileSize: typeof snapshot.fileSize === 'number'
                                    ? snapshot.fileSize
                                    : parseInt(snapshot.fileSize, 10)
                            }))
                            .sort((a, b) => (b.blockId || 0) - (a.blockId || 0));

                        renderRemoteSnapshots();

                        if (showToast) {
                            showNotification('success', 'Snapshots', 'Hosted snapshots refreshed.');
                        }
                        return;
                    }

                    throw new Error(data.error || 'Invalid snapshot response');
                } catch (error) {
                    console.error('Error loading hosted snapshots:', error);
                    remoteSnapshots = [];
                    renderRemoteSnapshots();
                    if (showToast) {
                        showNotification('warning', 'Snapshots', 'Unable to refresh hosted snapshots.');
                    }
                }
            };

            const downloadSnapshot = async (snapshot, triggerButton) => {
                if (!snapshot) {
                    return;
                }

                const button = triggerButton || null;
                const originalContent = button ? button.innerHTML : null;
                let downloadSuccess = false;
                let usedFallback = false;

                showSnapshotDownloadModal(snapshot);
                startSnapshotDownloadPolling();

                if (button) {
                    button.disabled = true;
                    button.innerHTML = '<span class="spinner-border"></span>';
                }

                try {
                    showNotification('info', 'Snapshot Download', `Downloading snapshot ${snapshot.filename || ''}…`);

                    const payload = {
                        headerUrl: snapshot.headerUrl || null,
                        downloadUrl: snapshot.downloadUrl || null,
                        filename: snapshot.filename || null
                    };

                    let response = await fetch('/download-snapshot', {
                        method: 'POST',
                        headers: {
                            'Access-Code': password,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 404 && payload.headerUrl) {
                        // Fallback for older servers without the new endpoint
                        response = await fetch('/create-backup-from-b2', {
                            method: 'POST',
                            headers: {
                                'Access-Code': password,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ headerUrl: payload.headerUrl })
                        });
                        usedFallback = true;
                    }

                    let data = null;
                    let parseError = null;
                    try {
                        data = await response.clone().json();
                    } catch (err) {
                        parseError = err;
                    }

                    if (response.ok && data?.success) {
                        downloadSuccess = true;
                        showNotification('success', 'Snapshot Downloaded', 'Snapshot saved to local backups.');
                        await loadBackups();

                        if (usedFallback) {
                            stopSnapshotDownloadPolling();
                            hideSnapshotDownloadModal();
                        }
                        return;
                    }

                    let errorMessage = data?.error;
                    if (response.status === 404) {
                        errorMessage = usedFallback
                            ? 'Snapshot download endpoint is unavailable on this node. Please update the backend or use the direct download link.'
                            : 'Snapshot download endpoint not found.';
                    }
                    if (!errorMessage) {
                        try {
                            errorMessage = await response.clone().text();
                        } catch (textErr) {
                            errorMessage = parseError ? parseError.message : 'Snapshot download failed';
                        }
                    }
                    throw new Error(errorMessage || 'Snapshot download failed');
                } catch (error) {
                    console.error('Snapshot download failed:', error);
                    stopSnapshotDownloadPolling();
                    hideSnapshotDownloadModal();
                    showNotification('error', 'Snapshot Download', error.message || 'Snapshot download failed');
                } finally {
                    if (button) {
                        button.disabled = false;
                        button.innerHTML = originalContent || '<span class="material-icons">download</span>';
                    }
                    if (!downloadSuccess && !usedFallback) {
                        stopSnapshotDownloadPolling();
                        hideSnapshotDownloadModal();
                    }
                }
            };

            // Expose helper functions for inline handlers
            window.loadRemoteSnapshots = loadRemoteSnapshots;
            window.openSnapshotsPortal = openSnapshotsPortal;
            window.downloadSnapshot = downloadSnapshot;

            // Backup management functions
            const loadBackups = async () => {
                try {
                    const loadingElement = document.getElementById('loading-backups');
                    const tableElement = document.getElementById('backups-table');
                    const noBackupsElement = document.getElementById('no-backups');
                    const tableBody = document.getElementById('backups-table-body');

                    loadingElement.style.display = 'flex';
                    tableElement.style.display = 'none';
                    noBackupsElement.style.display = 'none';

                    const response = await fetch('/get-backups', {
                        method: 'GET',
                        headers: {
                            'Access-Code': password,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const data = await response.json();
                    if (data.success && Array.isArray(data.backups) && data.backups.length > 0) {
                        loadingElement.style.display = 'none';
                        tableBody.innerHTML = '';

                        data.backups.forEach(backup => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td class="block-id">${backup.blockId.toLocaleString()}</td>
                                <td class="date-time">${backup.formattedDateTime}</td>
                                <td class="filename">${backup.filename}</td>
                                <td class="file-size">${formatFileSize(backup.size)}</td>
                                <td class="actions">
                                    <button class="button tertiary small" onclick="downloadBackup('${backup.filename}')" title="Download">
                                        <span class="material-icons">download</span>
                                    </button>
                                    <button class="button danger small" onclick="showApplyBackupModal('${backup.filename}', ${backup.blockId})" title="Apply Backup">
                                        <span class="material-icons">restore</span>
                                    </button>
                                    <button class="button danger small" onclick="showDeleteBackupModal('${backup.filename}', ${backup.blockId})" title="Delete Backup">
                                        <span class="material-icons">delete</span>
                                    </button>
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });

                        tableElement.style.display = 'block';
                        return;
                    }

                    loadingElement.style.display = 'none';
                    noBackupsElement.style.display = 'block';
                } catch (error) {
                    console.error('Error loading backups:', error);
                    showNotification('error', 'Error', 'Failed to load backups');
                }
            };
            window.loadBackups = loadBackups;

            const downloadBackup = async (filename) => {
                try {
                    // Show loading state
                    showNotification('info', 'Downloading', 'Preparing backup download...');
                    
                    // Use the API function to download the backup
                    const blob = await apiDownloadBackup(filename);
                    
                    // Create download link
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Clean up the URL object
                    window.URL.revokeObjectURL(url);
                    
                    showNotification('success', 'Download Complete', 'Backup downloaded successfully!');
                    
                } catch (error) {
                    console.error('Error downloading backup:', error);
                    showNotification('error', 'Download Failed', `Failed to download backup: ${error.message}`);
                }
            };

            let selectedBackupFilename = null;

            const showApplyBackupModal = (filename, blockHeight) => {
                selectedBackupFilename = filename;
                document.getElementById('modal-filename').textContent = filename;
                document.getElementById('modal-block-height').textContent = blockHeight.toLocaleString();
                document.getElementById('apply-backup-modal').style.display = 'flex';
            };

            const hideApplyBackupModal = () => {
                document.getElementById('apply-backup-modal').style.display = 'none';
                selectedBackupFilename = null;
            };

            const applyBackup = async () => {
                if (!selectedBackupFilename) {
                    showNotification('error', 'Error', 'No backup selected');
                    return;
                }

                const backupCurrentData = document.getElementById('backup-current-data').checked;
                
                try {
                    // Show loading state
                    const applyButton = document.querySelector('#apply-backup-modal .button.danger');
                    const originalText = applyButton.innerHTML;
                    applyButton.innerHTML = '<span class="spinner-border"></span> Applying...';
                    applyButton.disabled = true;

                    const response = await fetch('/apply-backup', {
                        method: 'POST',
                        headers: {
                            'Access-Code': password,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            filename: selectedBackupFilename,
                            backupCurrentData: backupCurrentData
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            showNotification('success', 'Success', 'Backup applied successfully!');
                            hideApplyBackupModal();
                            // Refresh the backups list to show the new backup if created
                            await loadBackups();
                        } else {
                            showNotification('error', 'Error', 'Failed to apply backup: ' + data.error);
                        }
                    } else {
                        showNotification('error', 'Error', 'Failed to apply backup');
                    }
                } catch (error) {
                    console.error('Error applying backup:', error);
                    showNotification('error', 'Error', 'Failed to apply backup');
                } finally {
                    // Restore button state
                    const applyButton = document.querySelector('#apply-backup-modal .button.danger');
                    applyButton.innerHTML = '<span class="material-icons">restore</span> Apply Backup';
                    applyButton.disabled = false;
                }
            };

            const showCreateBackupModal = async () => {
                try {
                    // Show loading state in modal
                    const previewInfo = document.getElementById('backup-preview-info');
                    previewInfo.innerHTML = '<div class="loading-spinner"><span class="spinner-border"></span> Loading...</div>';
                    
                    document.getElementById('create-backup-modal').style.display = 'flex';
                    document.getElementById('backup-preview-content').style.display = 'block';
                    document.getElementById('backup-error-content').style.display = 'none';
                    document.getElementById('confirm-create-backup').style.display = 'none';

                    const response = await fetch('/get-backup-preview', {
                        method: 'GET',
                        headers: {
                            'Access-Code': password,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            if (data.canCreateBackup) {
                                // Show preview
                                const now = new Date();
                                const timestamp = now.toISOString().slice(0, 19).replace(/:/g, '-').replace('T', '_');
                                const previewFilename = `snapshot_${data.blockHeight}_${timestamp}.tar.gz`;
                                
                                previewInfo.innerHTML = `
                                    <div class="preview-item">
                                        <strong>Current Block Height:</strong> ${data.blockHeight.toLocaleString()}
                                    </div>
                                    <div class="preview-item">
                                        <strong>Backup Filename:</strong> ${previewFilename}
                                    </div>
                                    <div class="preview-item">
                                        <strong>Files to backup:</strong> ${data.files.join(', ')}
                                    </div>
                                    <div class="preview-item">
                                        <strong>Backup Directory:</strong> ${data.backupDir}
                                    </div>
                                `;
                                
                                document.getElementById('confirm-create-backup').style.display = 'inline-flex';
                            } else {
                                // Show error
                                document.getElementById('backup-preview-content').style.display = 'none';
                                document.getElementById('backup-error-content').style.display = 'block';
                            }
                        } else {
                            showNotification('error', 'Error', 'Failed to get backup preview: ' + data.error);
                            hideCreateBackupModal();
                        }
                    } else {
                        showNotification('error', 'Error', 'Failed to get backup preview');
                        hideCreateBackupModal();
                    }
                } catch (error) {
                    console.error('Error getting backup preview:', error);
                    showNotification('error', 'Error', 'Failed to get backup preview');
                    hideCreateBackupModal();
                }
            };

            const hideCreateBackupModal = () => {
                document.getElementById('create-backup-modal').style.display = 'none';
            };

            const confirmCreateBackup = async () => {
                try {
                    // Show loading state
                    const confirmButton = document.getElementById('confirm-create-backup');
                    const originalText = confirmButton.innerHTML;
                    confirmButton.innerHTML = '<span class="spinner-border"></span> Creating...';
                    confirmButton.disabled = true;

                    const response = await fetch('/create-backup', {
                        method: 'POST',
                        headers: {
                            'Access-Code': password,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({})
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            showNotification('success', 'Success', `Backup created successfully! (Block ${data.backup.blockHeight})`);
                            hideCreateBackupModal();
                            // Refresh the backups list to show the new backup
                            await loadBackups();
                        } else {
                            showNotification('error', 'Error', 'Failed to create backup: ' + data.error);
                        }
                    } else {
                        showNotification('error', 'Error', 'Failed to create backup');
                    }
                } catch (error) {
                    console.error('Error creating backup:', error);
                    showNotification('error', 'Error', 'Failed to create backup');
                } finally {
                    // Restore button state
                    const confirmButton = document.getElementById('confirm-create-backup');
                    confirmButton.innerHTML = '<span class="material-icons">backup</span> Create Backup';
                    confirmButton.disabled = false;
                }
            };

            let selectedDeleteBackupFilename = null;

            const showDeleteBackupModal = (filename, blockHeight) => {
                selectedDeleteBackupFilename = filename;
                document.getElementById('delete-modal-filename').textContent = filename;
                document.getElementById('delete-modal-block-height').textContent = blockHeight.toLocaleString();
                document.getElementById('delete-backup-modal').style.display = 'flex';
            };

            const hideDeleteBackupModal = () => {
                document.getElementById('delete-backup-modal').style.display = 'none';
                selectedDeleteBackupFilename = null;
            };

            const confirmDeleteBackup = async () => {
                if (!selectedDeleteBackupFilename) {
                    showNotification('error', 'Error', 'No backup selected for deletion');
                    return;
                }

                try {
                    // Show loading state
                    const deleteButton = document.querySelector('#delete-backup-modal .button.danger');
                    const originalText = deleteButton.innerHTML;
                    deleteButton.innerHTML = '<span class="spinner-border"></span> Deleting...';
                    deleteButton.disabled = true;

                    const response = await fetch('/delete-backup', {
                        method: 'POST',
                        headers: {
                            'Access-Code': password,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            filename: selectedDeleteBackupFilename
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            showNotification('success', 'Success', 'Backup deleted successfully!');
                            hideDeleteBackupModal();
                            // Refresh the backups list
                            await loadBackups();
                        } else {
                            showNotification('error', 'Error', 'Failed to delete backup: ' + data.error);
                        }
                    } else {
                        showNotification('error', 'Error', 'Failed to delete backup');
                    }
                } catch (error) {
                    console.error('Error deleting backup:', error);
                    showNotification('error', 'Error', 'Failed to delete backup');
                } finally {
                    // Restore button state
                    const deleteButton = document.querySelector('#delete-backup-modal .button.danger');
                    deleteButton.innerHTML = '<span class="material-icons">delete</span> Delete Backup';
                    deleteButton.disabled = false;
                }
            };

            
            const main = async () => {
                if (password == undefined) {
                    window.location = '/';
                    return;
                }
                if (!(await isSetup())) {
                    window.location = '/setup';
                    return;
                }
                displaySideBar();
                document.querySelectorAll('.main-content')[0].style.display = '';
                await Promise.all([loadBackups(), loadRemoteSnapshots()]);
            };

            window.addEventListener('DOMContentLoaded', async (event) => {
                await main();
            });
        </script>
        <script src="js/theme.js"></script>
        <script src="js/side-bar.js"></script>
        <script src="js/utils.js"></script>
        <script src="js/api.js"></script>
    </body>
</html> 
