<html>
    <head>
        <title>Helios Node</title>
        <link rel="icon" type="image/png" href="favicon.png">
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
        <link rel="stylesheet" href="style.css">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>
        <div class="sidebar"></div>

        <!-- Notification Container -->
        <div class="notification-container" id="notification-container"></div>

        <div class="main-content" style="display: none">
            <div class="status-page">
                <section class="status-panels">
                    <!-- Hero Header -->
                    <article class="status-card status-overview-card">
                        <div class="overview-header">
                            <div class="status-hero-text">
                                <span class="status-hero-eyebrow">Network Monitoring</span>
                                <h1>EthStats Configuration</h1>
                                <p>Connect your node to an EthStats server to monitor network statistics and node performance in real-time.</p>
                            </div>
                            <div class="status-hero-meta overview-summary">
                                <div class="summary-item">
                                    <span class="summary-label">Status</span>
                                    <div class="status-badge" id="ethstats-status-badge">Inactive</div>
                                </div>
                            </div>
                        </div>
                    </article>

                    <!-- Configuration Card -->
                    <article class="status-card">
                        <div class="card-header">
                            <div class="card-title">
                                <span class="material-icons">settings</span>
                                <div>
                                    <h2>EthStats Configuration</h2>
                                    <p>Configure your EthStats server connection and node identity.</p>
                                </div>
                            </div>
                        </div>
                        <div class="settings-body">
                            <form id="ethstats-form">
                                <div class="settings-group">
                                    <label for="server-url">Server URL</label>
                                    <input 
                                        type="text" 
                                        id="server-url" 
                                        name="server-url" 
                                        placeholder="Enter EthStats server URL"
                                        class="form-input"
                                    >
                                    <p class="help-text">The URL of the EthStats server to connect to</p>
                                </div>
                                
                                <div class="settings-group">
                                    <label for="node-name">Node Name</label>
                                    <input 
                                        type="text" 
                                        id="node-name" 
                                        name="node-name" 
                                        placeholder="Enter node name"
                                        class="form-input"
                                        minlength="4"
                                    >
                                    <p class="help-text">Your node's display name (minimum 4 characters required)</p>
                                </div>
                                
                                <div class="button-group">
                                    <button type="button" id="btnStart" class="button primary" onclick="startEthStats()">
                                        <span class="material-icons">play_arrow</span>
                                        Start EthStats
                                    </button>
                                    <button type="button" id="btnStop" class="button secondary" onclick="stopEthStats()" disabled>
                                        <span class="material-icons">stop</span>
                                        Stop EthStats
                                    </button>
                                </div>
                            </form>
                        </div>
                    </article>

                    <!-- Logs Card -->
                    <article class="status-card logs-card">
                        <div class="card-header">
                            <div class="card-title">
                                <span class="material-icons">terminal</span>
                                <div>
                                    <h2>EthStats Logs</h2>
                                    <p>Monitor the real-time output from the EthStats client.</p>
                                </div>
                            </div>
                            <button class="button tertiary" id="pause-ethstats-logs">Pause</button>
                        </div>
                        <div class="logs-container" id="ethstats-logs">
                            <pre></pre>
                        </div>
                    </article>
                </section>
            </div>
        </div>
        <script>
            let password = window.localStorage.getItem("access-code");
            
            // Variables pour mémoriser l'état précédent
            let lastEthStatsServerUrl = '';
            let lastEthStatsNodeName = '';
            let lastEthStatsLogs = '';

            const showNotification = (type, title, message, duration = 5000) => {
                const container = document.getElementById('notification-container');
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                
                const iconMap = {
                    success: 'check_circle',
                    error: 'error',
                    warning: 'warning',
                    info: 'info'
                };
                
                notification.innerHTML = `
                    <div class="notification-icon">
                        <span class="material-icons">${iconMap[type] || 'info'}</span>
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">${title}</div>
                        <div class="notification-message">${message}</div>
                    </div>
                    <button class="notification-close" onclick="this.parentElement.remove()">
                        <span class="material-icons">close</span>
                    </button>
                    <div class="notification-progress" style="width: 100%"></div>
                `;
                
                container.appendChild(notification);
                
                setTimeout(() => {
                    notification.classList.add('show');
                }, 10);
                
                if (duration > 0) {
                    setTimeout(() => {
                        notification.classList.add('hide');
                        setTimeout(() => {
                            if (notification.parentElement) {
                                notification.remove();
                            }
                        }, 400);
                    }, duration);
                    
                    const progress = notification.querySelector('.notification-progress');
                    progress.style.transition = `width ${duration}ms linear`;
                    setTimeout(() => {
                        progress.style.width = '0%';
                    }, 10);
                }
            };

            const startEthStats = async () => {
                const serverUrl = document.getElementById('server-url').value;
                const nodeName = document.getElementById('node-name').value;
                
                if (!serverUrl.trim()) {
                    showNotification('error', 'Invalid Input', 'Please enter a server URL');
                    return;
                }
                
                if (!nodeName.trim() || nodeName.trim().length < 4) {
                    showNotification('error', 'Invalid Input', 'Please enter a node name with at least 4 characters');
                    return;
                }
                
                const btnStart = document.getElementById('btnStart');
                btnStart.disabled = true;
                btnStart.innerHTML = '<span class="material-icons">hourglass_empty</span> Starting...';
                
                try {
                    showNotification('info', 'Starting EthStats', 'Connecting to EthStats server...');
                    await apiPost('/run-ethstats', { ethStatsServerUrl: serverUrl, ethStatsNodeName: nodeName });
                    showNotification('success', 'EthStats Started', 'Successfully connected to EthStats server');
                } catch (error) {
                    console.error('Error starting EthStats:', error);
                    showNotification('error', 'Error', 'Failed to start EthStats: ' + error.message);
                } finally {
                    btnStart.disabled = false;
                    btnStart.innerHTML = '<span class="material-icons">play_arrow</span> Start EthStats';
                }
            }
            
            const stopEthStats = async () => {
                const btnStop = document.getElementById('btnStop');
                btnStop.disabled = true;
                btnStop.innerHTML = '<span class="material-icons">hourglass_empty</span> Stopping...';
                
                try {
                    showNotification('info', 'Stopping EthStats', 'Disconnecting from EthStats server...');
                    await apiPost('/ethstats-kill', {}, "boolean");
                    showNotification('success', 'EthStats Stopped', 'Successfully disconnected from EthStats server');
                } catch (error) {
                    console.error('Error stopping EthStats:', error);
                    showNotification('error', 'Error', 'Failed to stop EthStats: ' + error.message);
                } finally {
                    btnStop.disabled = false;
                    btnStop.innerHTML = '<span class="material-icons">stop</span> Stop EthStats';
                }
            }

            const updateEthStatsDisplay = async () => {
                try {
                    let result = await fetch('/test', {
                        method: 'POST',
                        headers: {
                            'Access-Code': password
                        },
                        body: JSON.stringify({})
                    });
                    let jsonResult = await result.json();

                    const serverUrl = document.getElementById('server-url');
                    const nodeName = document.getElementById('node-name');
                    const btnStart = document.getElementById('btnStart');
                    const btnStop = document.getElementById('btnStop');
                    const statusBadge = document.getElementById('ethstats-status-badge');

                    // Update form values only if they changed
                    if (jsonResult.ethStats.serverUrl !== lastEthStatsServerUrl) {
                        serverUrl.value = jsonResult.ethStats.serverUrl || '';
                        lastEthStatsServerUrl = jsonResult.ethStats.serverUrl || '';
                    }
                    
                    if (jsonResult.ethStats.nodeName !== lastEthStatsNodeName) {
                        nodeName.value = jsonResult.ethStats.nodeName || '';
                        lastEthStatsNodeName = jsonResult.ethStats.nodeName || '';
                    }

                    // Update button states
                    if (jsonResult.ethStats.status == '1') {
                        btnStart.disabled = true;
                        btnStop.disabled = false;
                        if (statusBadge) {
                            statusBadge.textContent = 'Active';
                            statusBadge.className = 'status-badge active';
                        }
                    } else {
                        btnStart.disabled = false;
                        btnStop.disabled = true;
                        if (statusBadge) {
                            statusBadge.textContent = 'Inactive';
                            statusBadge.className = 'status-badge inactive';
                        }
                    }

                    // Update logs
                    const logsContainer = document.getElementById('ethstats-logs');
                    const pre = logsContainer.querySelector('pre');
                    if (pre && jsonResult.ethStats.logs) {
                        const newLogsContent = jsonResult.ethStats.logs.join('\n');
                        if (newLogsContent !== lastEthStatsLogs) {
                            pre.innerHTML = newLogsContent;
                            lastEthStatsLogs = newLogsContent;
                            if (!document.activeElement.isEqualNode(pre) && !document.activeElement.isEqualNode(logsContainer)) {
                                logsContainer.scrollTop = logsContainer.scrollHeight;
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error updating EthStats display:', error);
                }
            }

            const main = async () => {
                if (password == undefined) {
                    window.location = '/';
                    return;
                }
                if (!(await isSetup())) {
                    window.location = '/setup';
                    return;
                }
                displaySideBar();

                document.querySelectorAll('.main-content')[0].style.display = '';

                // Setup logs pause functionality
                let isPaused = false;
                const pauseButton = document.getElementById('pause-ethstats-logs');
                const logsContainer = document.getElementById('ethstats-logs');
                
                pauseButton.onclick = () => {
                    isPaused = !isPaused;
                    pauseButton.textContent = isPaused ? 'Resume' : 'Pause';
                    if (isPaused) {
                        logsContainer.style.border = '1px solid orange';
                    } else {
                        logsContainer.style.border = '';
                    }
                };

                // Initial display
                await updateEthStatsDisplay();

                // Update every 5 seconds
                setInterval(async () => {
                    if (!isPaused) {
                        await updateEthStatsDisplay();
                    }
                }, 5000);
            }

            window.addEventListener('DOMContentLoaded', async (event) => {
                await main();
            });
        </script>
        <script src="js/theme.js"></script>
        <script src="js/side-bar.js"></script>
        <script src="js/utils.js"></script>
        <script src="js/api.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    </body>
</html>